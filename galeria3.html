<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Histórico e Galeria - Vôlei BNH</title>  
   <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
   <link rel="icon" type="image/png" sizes="32x32" href="favicon.ico">
  <link rel="stylesheet" href="history.css?v=3.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://moment.github.io/luxon/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<style>

     /* Estilos para itens de mídia */
.game-media-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 10px;
  margin-top: 10px;
}

.game-media-item {
  position: relative;
  overflow: hidden;
  border-radius: 8px;
  cursor: pointer;
  aspect-ratio: 1 / 1;
  transition: transform 0.3s ease;
}

.game-media-item:hover {
  transform: scale(1.05);
}

.game-media-item img,
.game-media-item video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.game-media-item.local-video {
  position: relative;
}

.game-media-item.local-video .play-icon {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 2rem;
  color: rgba(255, 255, 255, 0.8);
  background: rgba(0, 0, 0, 0.5);
  border-radius: 50%;
  padding: 10px;
}

.game-media-item.youtube-video {
  position: relative;
}

.game-media-item.youtube-video .youtube-play-icon {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 2rem;
  color: #ff0000;
  background: rgba(0, 0, 0, 0.5);
  border-radius: 50%;
  padding: 10px;
}

.media-actions {
  position: absolute;
  bottom: 5px;
  right: 5px;
  display: flex;
  gap: 5px;
}

.like-btn, .comment-btn, .delete-media-btn {
  background: rgba(0, 0, 0, 0.7);
  color: white;
  border: none;
  border-radius: 5px;
  padding: 5px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 5px;
}

.like-btn i, .comment-btn i {
  font-size: 1rem;
}

.like-btn .fas.fa-heart {
  color: #ff4d4d;
}

.like-btn:hover, .comment-btn:hover, .delete-media-btn:hover {
  background: rgba(0, 0, 0, 0.9);
}

.delete-media-btn:hover {
  background: rgba(255, 0, 0, 0.7);
}

.like-count, .comment-count {
  font-size: 0.9rem;
}

.swal2-comments-popup {
  width: 600px;
  max-width: 99%;
  
}

.comments-container {
  margin-bottom: 10px;
}

.comment-item {
  padding: 10px;
  border-bottom: 1px solid #eee;
}

.delete-comment-btn {
  background: transparent;
  color: #d33;
  border: none;
  cursor: pointer;
}

.delete-comment-btn:hover {
  color: #ff4d4d;
}

#submitComment {
  background: #3085d6;
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: 5px;
  cursor: pointer;
}

#submitComment:hover {
  background: #2563b5;
}

#commentInput {
  border: 1px solid #ccc;
  border-radius: 5px;
  padding: 5px;
  resize: vertical;
}
</style>

<body>
  <div class="header">
    <button class="menu-toggle" id="menuToggle" style="font-size: 11px;">
      <i class="fas fa-bars" style="font-size: 20px;"></i><br><strong>Menu</strong>
    </button>
    <center><h2><i class="fas fa-camera"></i> Galeria BNH</h2></center>
  </div>
  
  <div class="sidebar" id="sidebar">
    <div class="sidebar-menu">
      <div class="user-profile">
        <img id="sidebarUserPhoto" class="sidebar-user-photo" src="" alt="Foto do usuário">
        <div class="sidebar-user-info">
          <div id="sidebarUserName" class="sidebar-user-name"></div>
          <div id="sidebarUserPosition" class="sidebar-user-position"></div>
          <div id="sidebarUserCategory" class="sidebar-user-position"></div>
          
        </div>
      </div>
      <button id="adminBtn" class="logout-btn" onclick="window.location.href='dashboard.html'"><i class="fas fa-gear"></i> Administração</button>
      <button class="logout-btn" onclick="window.location.href='transparencia.html'"><i class="fas fa-hand-holding-usd"></i> Transparência</button>
      <button class="logout-btn" onclick="window.location.href='enquete.html'"><i class="fas fa-question-circle"></i> Enquetes</button>
      <button class="logout-btn" onclick="window.location.href='lista.html'"><i class="fas fa-list"></i> Jogos</button>
      <button class="logout-btn" onclick="window.location.href='galeria3.html'"><i class="fas fa-camera"></i> Galeria</button>
    </div>
    <button id="logoutBtn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Sair</button>
  </div>
  
  <div class="overlay" id="overlay"></div>
  
  <div class="container">
    <div class="filter-container">
      <div>
        <label for="yearFilter">Ano:</label>
        <select id="yearFilter" class="filter-select">
          <option value="">Todos</option>
        </select>
      </div>
      <div>
        <label for="monthFilter">Mês:</label>
        <select id="monthFilter" class="filter-select">
          <option value="">Todos</option>
          <option value="01">Janeiro</option>
          <option value="02">Fevereiro</option>
          <option value="03">Março</option>
          <option value="04">Abril</option>
          <option value="05">Maio</option>
          <option value="06">Junho</option>
          <option value="07">Julho</option>
          <option value="08">Agosto</option>
          <option value="09">Setembro</option>
          <option value="10">Outubro</option>
          <option value="11">Novembro</option>
          <option value="12">Dezembro</option>
        </select>
      </div>
      <div>
        <label for="playerFilter">Meus Jogos:</label>
        <select id="playerFilter" class="filter-select" style="width: 200px;">
          <option value="all">Todos os jogos</option>
          <option value="mine">Somente meus jogos</option>
        </select>
      </div>
      <button id="applyFilters" class="filter-btn"><i class="fas fa-filter"></i> Aplicar Filtros</button>
    </div>
    
    <div class="gallery-section">
      <h3><i class="fas fa-camera"></i> Foto do Mês</h3>
      <div id="galleryGrid" class="gallery-grid">
        <p class="no-items-message" id="noGalleryItems">Vôlei BNH</p>
      </div>
      <div class="upload-button-container">
        <button id="uploadPhotoBtn" class="upload-photo-btn admin-only" style="display: none;"><i class="fas fa-cloud-upload-alt"></i> Enviar Foto do Mês</button>
      </div>
    </div>

    <div id="historyList"></div>
  </div>
  
  <footer class="footer">
    © 2025 SMV Eletrônica - Todos os direitos reservados<br>
    <div class="footer-links">
      Powered by:
      <a href="https://github.com/SMV-Eletronica" target="_blank" class="github-link">
        <i class="fab fa-github"></i> GitHub
      </a>
      <a href="https://firebase.google.com/" target="_blank" class="firebase-link">
        <i class="fas fa-fire"></i> Firebase
      </a>
    </div>
  </footer>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, get, query, orderByChild, equalTo, push, set, remove, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWMgLaPMpNOdPW10S-bVVEiQW-r3QCkxg",
      authDomain: "volei-25301.firebaseapp.com",
      databaseURL: "https://volei-25301-default-rtdb.firebaseio.com",
      projectId: "volei-25301",
      storageBucket: "volei-25301.firebasestorage.app",
      messagingSenderId: "1007197261034",
      appId: "1:1007197261034:web:f2c7ab9cb2793a694cdb93",
      measurementId: "G-CYMLX0SJJQ"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth(app);
    const storage = getStorage(app);
    
    const { DateTime } = luxon;
    luxon.Settings.defaultLocale = 'pt-BR';
    
    let currentUser = null;
    let currentUserPlayer = null;
    let allPlayers = [];
    let isAdmin = false;
    const adminEmails = ['mvvasques@msn.com', 'mvv@msn.com', 'evandroAsyncronousFunctionCall@msn.com'];
    const defaultImage = 'https://firebasestorage.googleapis.com/v0/b/volei-25301.firebasestorage.app/o/players%2Fvisitante161.jpeg?alt=media&token=ed313e05-297e-4fe1-bdd6-699424719a7f';
    
    // Elementos da página
    const historyList = document.getElementById('historyList');
    const yearFilter = document.getElementById('yearFilter');
    const monthFilter = document.getElementById('monthFilter');
    const playerFilter = document.getElementById('playerFilter');
    const applyFilters = document.getElementById('applyFilters');
    const galleryGrid = document.getElementById('galleryGrid');
    const noGalleryItems = document.getElementById('noGalleryItems');
    const uploadPhotoBtn = document.getElementById('uploadPhotoBtn');
    
    // Menu toggle
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const adminBtn = document.getElementById('adminBtn');
    
    function toggleSidebar() {
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }
    
    menuToggle.addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', toggleSidebar);
    
    // Função para obter ID do YouTube
    function getYouTubeId(url) {
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    }

    // Carregar dados do usuário
    async function loadCurrentUser() {
      try {
        const playersRef = ref(database, 'players');
        const snapshot = await get(playersRef);
        
        if (snapshot.exists()) {
          allPlayers = Object.entries(snapshot.val()).map(([id, player]) => ({
            id,
            ...player
          }));
          
          currentUserPlayer = allPlayers.find(player => player.email === currentUser.email);
          
          if (currentUserPlayer) {
            document.getElementById('sidebarUserName').textContent = currentUserPlayer.name;
            document.getElementById('sidebarUserPosition').textContent = currentUserPlayer.position || 'Posição não definida';
            document.getElementById('sidebarUserCategory').textContent = currentUserPlayer.category || 'Categoria não definida';
            
            if (currentUserPlayer.imageUrl) {
              document.getElementById('sidebarUserPhoto').src = currentUserPlayer.imageUrl;
            }
            isAdmin = adminEmails.includes(currentUser.email) || currentUserPlayer.category === 'ADMIN';
            console.log('Usuário é admin?', isAdmin, 'Email:', currentUser.email);
            updateSidebarVisibility();
          }
        }
      } catch (error) {
        console.error('Erro ao carregar dados do usuário:', error);
      }
    }
    
    // Atualizar visibilidade da sidebar
    function updateSidebarVisibility() {
      console.log('Atualizando visibilidade - isAdmin:', isAdmin);
      if (isAdmin) {
        adminBtn.style.display = 'inline-block';
        uploadPhotoBtn.style.display = 'inline-block';
        document.querySelectorAll('.admin-only').forEach(btn => {
          console.log('Mostrando botão admin:', btn.id);
          btn.style.display = 'inline-block';
        });
      } else {
        adminBtn.style.display = 'none';
        uploadPhotoBtn.style.display = 'none';
        document.querySelectorAll('.admin-only').forEach(btn => {
          console.log('Ocultando botão admin:', btn.id);
          btn.style.display = 'none';
        });
      }
    }
    
    // Carregar anos disponíveis
    async function loadAvailableYears() {
      try {
        const historyRef = ref(database, 'gameHistory');
        const snapshot = await get(historyRef);
        
        yearFilter.innerHTML = '<option value="">Todos</option>';
        
        if (snapshot.exists()) {
          const years = Object.keys(snapshot.val()).sort((a, b) => b - a);
          const currentYear = DateTime.now().toFormat('yyyy');
          const currentMonth = DateTime.now().toFormat('MM');
          
          years.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearFilter.appendChild(option);
          });
          
          if (years.includes(currentYear)) {
            yearFilter.value = currentYear;
            monthFilter.value = currentMonth;
            
            const monthsRef = ref(database, `gameHistory/${currentYear}`);
            const monthsSnapshot = await get(monthsRef);
            
            if (monthsSnapshot.exists()) {
              const months = Object.keys(monthsSnapshot.val());
              if (!months.includes(currentMonth)) {
                monthFilter.value = months[0] || '';
              }
            }
          } else if (years.length > 0) {
            yearFilter.value = years[0];
            monthFilter.value = '';
          }
          
          const filters = {
            year: yearFilter.value,
            month: monthFilter.value,
            onlyMyGames: playerFilter.value === 'mine'
          };
          await loadGameHistory(filters);
          await loadGallery(filters);
        }
      } catch (error) {
        console.error('Erro ao carregar anos:', error);
        Swal.fire('Erro', 'Não foi possível carregar os anos disponíveis.', 'error');
      }
    }  

    // Função para deletar mídia
    async function deleteMedia(mediaId, mediaUrl, mediaType) {
      const { isConfirmed } = await Swal.fire({
        title: 'Remover Mídia?',
        text: 'Tem certeza que deseja remover este item? Esta ação é irreversível.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sim, Remover!'
      });

      if (isConfirmed) {
        try {
          const mediaRef = ref(database, `gallery/${mediaId}`);
          await remove(mediaRef);

          if (mediaType !== 'youtube_video' && mediaUrl) {
            const fileToDeleteRef = storageRef(storage, mediaUrl);
            try {
              await deleteObject(fileToDeleteRef);
              console.log('Arquivo removido do Firebase Storage.');
            } catch (storageError) {
              if (storageError.code === 'storage/object-not-found') {
                console.warn('Arquivo não encontrado no Storage, mas removido do Realtime Database.');
              } else {
                console.error('Erro ao remover arquivo do Storage:', storageError);
              }
            }
          }

          Swal.fire('Removido!', 'Item removido com sucesso.', 'success');
        } catch (error) {
          console.error('Erro ao remover mídia:', error);
          Swal.fire('Erro', 'Não foi possível remover o item. Tente novamente.', 'error');
        }
      }
    }

    // Função para fazer upload da Foto do Mês
    async function uploadGalleryPhoto() {
      if (!isAdmin) {
        Swal.fire('Erro', 'Você não tem permissão para enviar arquivos.', 'error');
        return;
      }

      const { value: file } = await Swal.fire({
        title: 'Selecionar Foto do Mês',
        input: 'file',
        inputAttributes: {
          'accept': 'image/*',
          'aria-label': 'Upload da Foto do Mês'
        },
        showCancelButton: true,
        confirmButtonText: 'Enviar Foto',
        preConfirm: (fileInput) => {
          if (!fileInput) {
            Swal.showValidationMessage('Por favor, selecione uma imagem.');
          }
          if (!fileInput.type.startsWith('image/')) {
            Swal.showValidationMessage('Apenas imagens são permitidas.');
          }
          return fileInput;
        }
      });

      if (file) {
        Swal.fire({
          title: 'Enviando foto...',
          text: 'Por favor, aguarde.',
          allowOutsideClick: false,
          didOpen: () => { Swal.showLoading(); }
        });

        try {
          const now = DateTime.local().setZone('America/Sao_Paulo');
          const year = now.toFormat('yyyy');
          const month = now.toFormat('MM');
          
          const galleryRef = query(ref(database, 'gallery'), orderByChild('year'), equalTo(year));
          const snapshot = await get(galleryRef);
          let existingMediaId = null;
          let existingMediaUrl = null;
          
          if (snapshot.exists()) {
            const items = snapshot.val();
            for (const [id, item] of Object.entries(items)) {
              if (item.month === month && item.type === 'image' && !item.gameId) {
                existingMediaId = id;
                existingMediaUrl = item.url;
                break;
              }
            }
          }

          const fileExtension = file.name.split('.').pop();
          const storagePath = `gallery/${year}/${month}/photo_of_the_month.${fileExtension}`;
          const storageRefPath = storageRef(storage, storagePath);
          await uploadBytes(storageRefPath, file);
          const downloadURL = await getDownloadURL(storageRefPath);

          if (existingMediaId && existingMediaUrl) {
            await remove(ref(database, `gallery/${existingMediaId}`));
            try {
              await deleteObject(storageRef(storage, existingMediaUrl));
              console.log('Imagem antiga removida do Storage.');
            } catch (storageError) {
              if (storageError.code !== 'storage/object-not-found') {
                console.error('Erro ao remover imagem antiga:', storageError);
              }
            }
          }

          const mediaId = push(ref(database, 'gallery')).key;
          await set(ref(database, `gallery/${mediaId}`), {
            url: downloadURL,
            caption: `Foto do Mês - ${month}/${year}`,
            uploadedBy: currentUserPlayer.id,
            uploadedAt: now.toISO(),
            type: 'image',
            year: year,
            month: month
          });

          Swal.fire('Sucesso!', 'Foto do Mês enviada com sucesso!', 'success');
        } catch (error) {
          console.error('Erro ao enviar foto:', error);
          Swal.fire('Erro', 'Não foi possível enviar a foto. Tente novamente.', 'error');
        }
      }
    }

    // Função para fazer upload de mídia para um jogo
    async function uploadGameMedia(gameId) {
      console.log('Tentando upload para jogo:', gameId);
      if (!isAdmin) {
        Swal.fire('Erro', 'Você não tem permissão para enviar arquivos.', 'error');
        return;
      }

      const { value: file } = await Swal.fire({
        title: `Enviar mídia para o jogo ${gameId}`,
        input: 'file',
        inputAttributes: {
          'accept': 'image/*,video/*',
          'aria-label': 'Upload da sua mídia'
        },
        showCancelButton: true,
        confirmButtonText: 'Enviar Arquivo',
        preConfirm: (fileInput) => {
          if (!fileInput) {
            Swal.showValidationMessage('Por favor, selecione uma imagem ou vídeo.');
          }
          return fileInput;
        }
      });

      if (file) {
        Swal.fire({
          title: 'Enviando arquivo...',
          text: 'Por favor, aguarde.',
          allowOutsideClick: false,
          didOpen: () => { Swal.showLoading(); }
        });

        try {
          const now = DateTime.local().setZone('America/Sao_Paulo');
          const year = now.toFormat('yyyy');
          const month = now.toFormat('MM');
          const timestamp = now.toFormat('yyyyMMddHHmmss');
          const fileExtension = file.name.split('.').pop();
          const storagePath = `gallery/${year}/${month}/game_${gameId}_${timestamp}.${fileExtension}`;
          const storageRefPath = storageRef(storage, storagePath);
          await uploadBytes(storageRefPath, file);
          const downloadURL = await getDownloadURL(storageRefPath);

          const mediaId = push(ref(database, 'gallery')).key;
          await set(ref(database, `gallery/${mediaId}`), {
            url: downloadURL,
            caption: `Mídia do jogo ${gameId}`,
            uploadedBy: currentUserPlayer.id,
            uploadedAt: now.toISO(),
            type: file.type.startsWith('image/') ? 'image' : 'video',
            gameId: gameId,
            year: year,
            month: month
          });

          Swal.fire('Sucesso!', 'Mídia enviada com sucesso para este jogo!', 'success');
        } catch (error) {
          console.error('Erro ao enviar arquivo:', error);
          Swal.fire('Erro', 'Não foi possível enviar o arquivo. Tente novamente.', 'error');
        }
      }
    }

    // Função para fazer upload de vídeo do YouTube
    async function uploadYoutubeVideo(gameId = null) {
      console.log('Tentando upload do YouTube para jogo:', gameId);
      if (!isAdmin) {
        Swal.fire('Erro', 'Você não tem permissão para adicionar vídeos do YouTube.', 'error');
        return;
      }

      const { value: youtubeUrl } = await Swal.fire({
        title: `Adicionar Vídeo do YouTube ao Jogo`,
        input: 'text',
        inputLabel: 'URL do vídeo do YouTube:',
        inputPlaceholder: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
        showCancelButton: true,
        confirmButtonText: 'Adicionar Vídeo',
        inputValidator: (value) => {
          const id = getYouTubeId(value);
          if (!id) {
            return 'Por favor, insira um URL válido do YouTube.';
          }
          return null;
        }
      });

      if (youtubeUrl) {
        Swal.fire({
          title: 'Adicionando vídeo...',
          text: 'Por favor, aguarde.',
          allowOutsideClick: false,
          didOpen: () => { Swal.showLoading(); }
        });

        try {
          const youtubeId = getYouTubeId(youtubeUrl);
          const mediaId = push(ref(database, 'gallery')).key;
          const mediaData = {
            youtubeId: youtubeId,
            caption: 'Vídeo do YouTube',
            uploadedBy: currentUserPlayer.id,
            uploadedAt: DateTime.local().setZone('America/Sao_Paulo').toISO(),
            type: 'youtube_video',
            gameId: gameId
          };
          await set(ref(database, `gallery/${mediaId}`), mediaData);
          Swal.fire('Sucesso!', 'Vídeo do YouTube adicionado!', 'success');
        } catch (error) {
          console.error('Erro ao adicionar vídeo do YouTube:', error);
          Swal.fire('Erro', 'Não foi possível adicionar o vídeo. Tente novamente.', 'error');
        }
      }
    }

    // Função para mostrar e gerenciar comentários
    async function showComments(mediaId, mediaUrl, mediaType, youtubeId) {
      if (!currentUserPlayer) {
        Swal.fire('Erro', 'Você precisa estar logado para visualizar ou adicionar comentários.', 'error');
        return;
      }

      const commentsRef = ref(database, `gallery/${mediaId}/comments`);
      let commentsHtml = '<div class="comments-container" style="max-height: 300px; overflow-y: auto;">';
      
      // Carregar comentários
      const snapshot = await get(commentsRef);
      const comments = snapshot.exists() ? Object.entries(snapshot.val()).map(([id, comment]) => ({ id, ...comment })) : [];
      comments.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

      if (comments.length === 0) {
        commentsHtml += '<p>Nenhum comentário ainda.</p>';
      } else {
        comments.forEach(comment => {
          const formattedDate = DateTime.fromISO(comment.timestamp, { zone: 'America/Sao_Paulo' }).toFormat('dd/MM/yyyy HH:mm');
          const canDelete = isAdmin || (currentUserPlayer && comment.userId === currentUserPlayer.id);
          commentsHtml += `
            <div class="comment-item" data-comment-id="${comment.id}">
              <span style="color: silver; font-size: 0.8em;">${comment.userName}</span> <span style="color: silver; font-size: 0.6em;">(${formattedDate})</span><br> <span style=" font-size: 0.9em; color: white;"> ${comment.text}</span>
              ${canDelete ? `<button class="delete-comment-btn" data-comment-id="${comment.id}" style="margin-left: 10px;"><i class="fas fa-trash"></i></button>` : ''}
            </div>
          `;
        });
      }
      commentsHtml += '</div>';

      // Formulário para adicionar comentário
      const inputHtml = `
        <div style="margin-top: 10px;">
          <textarea id="commentInput" placeholder="Escreva seu comentário..." style="width: 100%; min-height: 60px;"></textarea>
          <button id="submitComment" style="margin-top: 5px;">Enviar</button>
        </div>
      `;

      // Exibir mídia na janela de comentários
      let mediaContent = '';
      if (mediaType === 'image') {
        mediaContent = `<img src="${mediaUrl}" style="max-width: 100%; max-height: 200px; margin-bottom: 10px;">`;
      } else if (mediaType === 'video') {
        mediaContent = `<video src="${mediaUrl}" controls style="max-width: 100%; max-height: 300px; margin-bottom: 10px;"></video>`;
      } else if (mediaType === 'youtube_video') {
        mediaContent = `
          <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; margin-bottom: 10px;">
            <iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                    src="https://www.youtube.com/embed/${youtubeId}"
                    frameborder="0"
                    allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
            </iframe>
          </div>
        `;
      }

      Swal.fire({
        title: 'Destaques',
        html: mediaContent + commentsHtml + inputHtml,
        showConfirmButton: false,
        showCloseButton: true,
        focusConfirm: false,
        customClass: {
          popup: 'swal2-comments-popup'
        },
        didOpen: () => {
          const submitButton = document.getElementById('submitComment');
          const commentInput = document.getElementById('commentInput');

          submitButton.addEventListener('click', async () => {
            const commentText = commentInput.value.trim();
            if (!commentText) {
              Swal.showValidationMessage('Por favor, escreva um comentário.');
              return;
            }

            try {
              const commentId = push(commentsRef).key;
              await set(ref(database, `gallery/${mediaId}/comments/${commentId}`), {
                userId: currentUserPlayer.id,
                userName: currentUserPlayer.name,
                text: commentText,
                timestamp: DateTime.local().setZone('America/Sao_Paulo').toISO()
              });
              commentInput.value = '';
              Swal.fire('Sucesso!', 'Comentário adicionado.', 'success');
              showComments(mediaId, mediaUrl, mediaType, youtubeId); // Recarregar janela
            } catch (error) {
              console.error('Erro ao adicionar comentário:', error);
              Swal.fire('Erro', 'Não foi possível adicionar o comentário. Tente novamente.', 'error');
            }
          });

          document.querySelectorAll('.delete-comment-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
              const commentId = e.target.closest('.delete-comment-btn').dataset.commentId;
              const { isConfirmed } = await Swal.fire({
                title: 'Remover Comentário?',
                text: 'Tem certeza que deseja remover este comentário?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, Remover!'
              });

              if (isConfirmed) {
                try {
                  await remove(ref(database, `gallery/${mediaId}/comments/${commentId}`));
                  Swal.fire('Removido!', 'Comentário removido com sucesso.', 'success');
                  showComments(mediaId, mediaUrl, mediaType, youtubeId); // Recarregar janela
                } catch (error) {
                  console.error('Erro ao remover comentário:', error);
                  Swal.fire('Erro', 'Não foi possível remover o comentário. Tente novamente.', 'error');
                }
              }
            });
          });
        }
      });
    }

    // Carregar galeria (Foto do Mês)
    async function loadGallery(filters = {}) {
      const galleryRef = ref(database, 'gallery');
      onValue(galleryRef, (snapshot) => {
        const items = snapshot.val() || {};
        const galleryItems = Object.entries(items)
          .map(([id, item]) => ({ id, ...item }))
          .filter(item => item.type === 'image' && !item.gameId)
          .sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));

        let selectedImage = null;

        if (filters.year && filters.month) {
          selectedImage = galleryItems.find(item => item.year === filters.year && item.month === filters.month);
        } else {
          selectedImage = galleryItems[0];
        }

        if (selectedImage) {
          galleryGrid.style.backgroundImage = `url('${selectedImage.url}')`;
          noGalleryItems.style.display = 'none';
          galleryGrid.dataset.id = selectedImage.id;
          galleryGrid.dataset.url = selectedImage.url;
          galleryGrid.dataset.type = selectedImage.type;
        } else {
          galleryGrid.style.backgroundImage = `url('${defaultImage}')`;
          noGalleryItems.style.display = 'block';
          galleryGrid.dataset.id = '';
          galleryGrid.dataset.url = defaultImage;
          galleryGrid.dataset.type = 'image';
        }

        if (isAdmin && selectedImage) {
          galleryGrid.innerHTML = `<button class="delete-photo-btn" data-id="${selectedImage.id}"><i class="fas fa-trash"></i></button>`;
        } else {
          galleryGrid.innerHTML = '';
          if (!selectedImage) {
            galleryGrid.innerHTML = 'VôleiBNH';
          }
        }

        galleryGrid.addEventListener('click', (e) => {
          if (!e.target.classList.contains('delete-photo-btn') && !e.target.closest('.delete-photo-btn')) {
            const url = galleryGrid.dataset.url;
            const type = galleryGrid.dataset.type;
            if (url && type === 'image') {
              showComments(galleryGrid.dataset.id, url, type, null);
            }
          }
        });

        if (isAdmin) {
          const deleteButton = galleryGrid.querySelector('.delete-photo-btn');
          if (deleteButton) {
            deleteButton.addEventListener('click', (e) => {
              const mediaId = e.target.dataset.id || e.target.closest('button').dataset.id;
              const mediaUrl = galleryGrid.dataset.url;
              const mediaType = galleryGrid.dataset.type;
              deleteMedia(mediaId, mediaUrl, mediaType);
            });
          }
        }
      }, (error) => {
        console.error("Erro ao carregar galeria:", error);
        Swal.fire({
          icon: 'error',
          title: 'Erro',
          text: 'Não foi possível carregar a Foto do Mês.',
        });
      });
    }

    // Carregar histórico de jogos
    async function loadGameHistory(filters = {}) {
      try {
        historyList.innerHTML = '<p>Carregando histórico...</p>';
        
        let historyQuery;
        
        if (filters.year && filters.month) {
          historyQuery = ref(database, `gameHistory/${filters.year}/${filters.month}`);
        } else if (filters.year) {
          historyQuery = ref(database, `gameHistory/${filters.year}`);
        } else {
          historyQuery = ref(database, 'gameHistory');
        }
        
        const snapshot = await get(historyQuery);
        
        if (!snapshot.exists()) {
          historyList.innerHTML = '<p>Nenhum jogo encontrado no histórico.</p>';
          return;
        }
        
        let games = [];
        
        const data = snapshot.val();
        if (filters.year && filters.month) {
          Object.entries(data).forEach(([gameId, gameData]) => {
            games.push({
              id: gameId,
              year: filters.year,
              month: filters.month,
              ...gameData
            });
          });
        } else if (filters.year) {
          Object.entries(data).forEach(([month, monthGames]) => {
            Object.entries(monthGames).forEach(([gameId, gameData]) => {
              games.push({
                id: gameId,
                year: filters.year,
                month,
                ...gameData
              });
            });
          });
        } else {
          Object.entries(data).forEach(([year, yearData]) => {
            Object.entries(yearData).forEach(([month, monthGames]) => {
              Object.entries(monthGames).forEach(([gameId, gameData]) => {
                games.push({
                  id: gameId,
                  year,
                  month,
                  ...gameData
                });
              });
            });
          });
        }
        
        games.sort((a, b) => {
          const dateA = new Date(`${a.date}T${a.time}`);
          const dateB = new Date(`${b.date}T${b.time}`);
          return dateB - dateA;
        });
        
        if (filters.onlyMyGames && currentUserPlayer) {
          const myGames = [];
          
          for (const game of games) {
            const confirmedIds = Object.keys(game.confirmedPlayers || {});
            
            if (confirmedIds.includes(currentUserPlayer.id)) {
              myGames.push({ ...game, myStatus: 'confirmed' });
            }
          }
          
          games = myGames;
        }
        
        if (games.length === 0) {
          historyList.innerHTML = '<p>Nenhum jogo encontrado com os filtros selecionados.</p>';
          return;
        }
        
        const galleryRef = ref(database, 'gallery');
        const gallerySnapshot = await get(galleryRef);
        const mediaItems = gallerySnapshot.exists() ? Object.entries(gallerySnapshot.val()).map(([id, item]) => ({ id, ...item })) : [];

        historyList.innerHTML = '';
        
        for (const game of games) {
          const gameDate = DateTime.fromISO(game.date, { zone: 'America/Sao_Paulo' });
          const formattedDate = gameDate.toFormat('dd/MM/yyyy');
          const formattedTime = DateTime.fromISO(`2000-01-01T${game.time}`).toFormat('HH:mm');
          const dayOfWeek = gameDate.toFormat('EEEE', { locale: 'pt-BR' });
          
          const gameCard = document.createElement('div');
          gameCard.className = 'game-card';
          
          let headerHtml = `
            <div class="game-header">
              <h3>Histórico de Presença: ${formattedDate} - ${dayOfWeek} às ${formattedTime}</h3>
          `;
          
          if (game.myStatus) {
            headerHtml += `<span class="my-status">(${game.myStatus === 'confirmed' ? 'Participou' : ''})</span>`;
          }
          
          headerHtml += `</div>Total presentes: ${Object.keys(game.confirmedPlayers || {}).length} Jogadores`;
          
          let playersHtml = '<div class="players-grid">';
          
          const confirmedPlayers = Object.values(game.confirmedPlayers || {});
          confirmedPlayers.forEach(player => {
            const playerData = allPlayers.find(p => p.id === player.id) || player;
            playersHtml += `
              <div class="player-avatar-container">
                <div class="player-avatar">
                  <img src="${playerData.imageUrl || defaultImage}" alt="${playerData.name}">
                </div>
                <div class="player-tooltip">
                  <strong>${playerData.name}</strong><br>${playerData.position || 'Posição não definida'}
                </div>
              </div>
            `;
          });
          
          playersHtml += '</div>';

          let mediaHtml = '<div class="game-media-section">';
          mediaHtml += '<h4>Mídias do Jogo</h4>';
          
          const gameMediaItems = mediaItems.filter(item => item.gameId === game.id);
          
          if (gameMediaItems.length === 0) {
            mediaHtml += '<p class="no-media-message">Nenhuma mídia associada a este jogo.</p>';
          } else {
            mediaHtml += '<div class="game-media-grid">';
            for (const media of gameMediaItems) {
              let mediaContent = '';
              let itemClass = media.type === 'image' ? 'image' : media.type === 'video' ? 'local-video' : 'youtube-video';
              
              if (media.type === 'image') {
                mediaContent = `<img src="${media.url}" alt="${media.caption || 'Imagem do Jogo'}">`;
              } else if (media.type === 'video') {
                mediaContent = `
                  <video src="${media.url}" alt="${media.caption || 'Vídeo do Jogo'}" preload="metadata"></video>
                  <i class="fas fa-play play-icon"></i>
                `;
              } else if (media.type === 'youtube_video') {
                const thumbnailUrl = `https://img.youtube.com/vi/${media.youtubeId}/mqdefault.jpg`;
                mediaContent = `
                  <img src="${thumbnailUrl}" alt="${media.caption || 'Vídeo do YouTube'}">
                  <i class="fab fa-youtube youtube-play-icon"></i>
                `;
              }

              mediaHtml += `
                <div class="game-media-item ${itemClass}" data-url="${media.url || ''}" data-type="${media.type}" data-youtube-id="${media.youtubeId || ''}" data-media-id="${media.id}">
                  ${mediaContent}
                  <div class="media-actions">
                    <button class="like-btn" data-media-id="${media.id}" data-liked="false">
                      <i class="far fa-heart"></i> <span class="like-count">0</span>
                    </button>
                    <button class="comment-btn" data-media-id="${media.id}">
                      <i class="far fa-comment"></i> <span class="comment-count">0</span>
                    </button>
                    ${isAdmin ? `<button class="delete-media-btn" data-id="${media.id}"><i class="fas fa-trash"></i></button>` : ''}
                  </div>
                </div>
              `;
            }
            mediaHtml += '</div>';
          }

          if (isAdmin) {
            mediaHtml += `
              <div class="game-media-buttons">
                <button class="upload-media-btn" data-game-id="${game.id}">
                  <i class="fas fa-cloud-upload-alt"></i> Enviar Foto/Vídeo
                </button>
                <button class="upload-youtube-game-btn" data-game-id="${game.id}">
                  <i class="fab fa-youtube"></i> Adicionar Vídeo do YouTube
                </button>
              </div>
            `;
          }
          
          mediaHtml += '</div>';
          
          gameCard.innerHTML = headerHtml + playersHtml + mediaHtml;
          historyList.appendChild(gameCard);
        }

        document.querySelectorAll('.upload-media-btn').forEach(button => {
          button.addEventListener('click', (e) => {
            e.stopPropagation();
            const gameId = button.dataset.gameId;
            uploadGameMedia(gameId);
          });
        });

        document.querySelectorAll('.upload-youtube-game-btn').forEach(button => {
          button.addEventListener('click', (e) => {
            e.stopPropagation();
            const gameId = button.dataset.gameId;
            uploadYoutubeVideo(gameId);
          });
        });

        document.querySelectorAll('.game-media-item').forEach(item => {
          item.addEventListener('click', (e) => {
            if (!e.target.classList.contains('delete-media-btn') && 
                !e.target.closest('.delete-media-btn') && 
                !e.target.classList.contains('like-btn') && 
                !e.target.closest('.like-btn') && 
                !e.target.classList.contains('comment-btn') && 
                !e.target.closest('.comment-btn')) {
              const mediaId = item.dataset.mediaId;
              const url = item.dataset.url;
              const type = item.dataset.type;
              const youtubeId = item.dataset.youtubeId;
              showComments(mediaId, url, type, youtubeId);
            }
          });
        });

        if (isAdmin) {
          document.querySelectorAll('.delete-media-btn').forEach(button => {
            button.addEventListener('click', (e) => {
              e.stopPropagation();
              const mediaId = button.dataset.id;
              const itemElement = button.closest('.game-media-item');
              const mediaUrl = itemElement.dataset.url;
              const mediaType = itemElement.dataset.type;
              deleteMedia(mediaId, mediaUrl, mediaType);
            });
          });
        }

        document.querySelectorAll('.like-btn').forEach(button => {
          const mediaId = button.dataset.mediaId;
          const likesRef = ref(database, `gallery/${mediaId}/likes`);

          onValue(likesRef, (snapshot) => {
            const likes = snapshot.val() || {};
            const likeCount = Object.keys(likes).length;
            const isLiked = currentUserPlayer && likes[currentUserPlayer.id];
            button.dataset.liked = isLiked ? 'true' : 'false';
            button.querySelector('.like-count').textContent = likeCount;
            button.querySelector('i').className = isLiked ? 'fas fa-heart' : 'far fa-heart';
          });

          button.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (!currentUserPlayer) {
              Swal.fire('Erro', 'Você precisa estar logado para curtir.', 'error');
              return;
            }
            const isLiked = button.dataset.liked === 'true';
            const userLikeRef = ref(database, `gallery/${mediaId}/likes/${currentUserPlayer.id}`);
            try {
              if (isLiked) {
                await remove(userLikeRef);
              } else {
                await set(userLikeRef, true);
              }
            } catch (error) {
              console.error('Erro ao curtir/descurtir:', error);
              Swal.fire('Erro', 'Não foi possível processar a curtida. Tente novamente.', 'error');
            }
          });
        });

        document.querySelectorAll('.comment-btn').forEach(button => {
          const mediaId = button.dataset.mediaId;
          const commentsRef = ref(database, `gallery/${mediaId}/comments`);

          onValue(commentsRef, (snapshot) => {
            const comments = snapshot.val() || {};
            const commentCount = Object.keys(comments).length;
            button.querySelector('.comment-count').textContent = commentCount;
          });

          button.addEventListener('click', (e) => {
            e.stopPropagation();
            const itemElement = button.closest('.game-media-item');
            const mediaId = itemElement.dataset.mediaId;
            const mediaUrl = itemElement.dataset.url;
            const mediaType = itemElement.dataset.type;
            const youtubeId = itemElement.dataset.youtubeId;
            showComments(mediaId, mediaUrl, mediaType, youtubeId);
          });
        });
      } catch (error) {
        console.error('Erro ao carregar histórico:', error);
        historyList.innerHTML = '<p>Ocorreu um erro ao carregar o histórico de jogos.</p>';
      }
    }

    applyFilters.addEventListener('click', () => {
      const filters = {
        year: yearFilter.value,
        month: monthFilter.value,
        onlyMyGames: playerFilter.value === 'mine'
      };
      loadGameHistory(filters);
      loadGallery(filters);
    });
    
    uploadPhotoBtn.addEventListener('click', uploadGalleryPhoto);

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      Swal.fire({
        title: 'Saindo...',
        text: 'Por favor, aguarde.',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
      });
      try {
        await signOut(auth);
        await Swal.fire({
          icon: 'success',
          title: 'Logout',
          text: 'Você saiu com sucesso.',
          timer: 1500,
          showConfirmButton: false,
        });
        window.location.assign('loginvl.html');
      } catch (error) {
        console.error('Erro ao fazer logout:', error);
        await Swal.fire({
          icon: 'error',
          title: 'Erro',
          text: 'Não foi possível fazer logout. Tente novamente.',
        });
      }
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        await Swal.fire({
          icon: 'error',
          title: 'Acesso Negado',
          text: 'Você precisa estar logado para acessar esta página.',
        });
        window.location.href = 'loginvl.html';
        return;
      }
      
      currentUser = user;
      await loadCurrentUser();
      await loadAvailableYears();
    });
  </script>
</body>
</html>
