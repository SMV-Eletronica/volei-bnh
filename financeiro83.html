<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro-Vôlei BNH</title>
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="styles.css">
    
    <style>
        .defaulter-item {
            cursor: pointer;
        }
        /* Estilo para o popup do SweetAlert2 */
        .swal-wide {
            width: 90% !important;
            max-width: 600px !important;
        }
        .swal-content {
            padding: 15px !important;
            text-align: center !important;
        }
        /* Estilos para o campo de arquivo */
        .form-group input[type="file"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
        }
        /* Estilo para links de comprovante */
        .receipt-link {
            color: #2196F3;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }
        .receipt-link:hover {
            text-decoration: underline;
        }
        /* Estilos para botões adicionados */
        .btn-cancel {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        .btn-cancel:hover {
            background-color: #d32f2f;
        }
        .btn-remove-receipt {
            background-color: #ff9800;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-remove-receipt:hover {
            background-color: #e68a00;
        }
        /* Estilo para despesas editáveis */
        .editable-expense:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>
    
<body>
    <div class="header">
        <center><h2><i class="fas fa-volleyball-ball" style="color:#3498db;"></i> Vôlei-BNH Gestão</h2></center>
        <div class="button-container">
            <button onclick="window.location.href='dashboard.html'"><i class="fas fa-user-plus"></i> Cadastro</button>            
            <button onclick="window.location.href='mensalidade.html'"><i class="fas fa-hand-holding-usd"></i> Contribuições</button>
            <button onclick="window.location.href='financeiro8.html'"><i class="fas fa-file-invoice-dollar"></i> Despesas</button>
            <button onclick="window.location.href='integrantes.html'"><i class="fas fa-users"></i> Integrantes</button>   
            <button onclick="window.location.href='lista.html'"><i class="fas fa-list"></i> Jogos</button>     
            <button id="logoutBtn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </div>
    </div>
    
    <div class="container">
        <div id="userEmail"></div>
        <br>
        <div class="tabs">
            <div class="tab active" data-tab="expenses"><i class="fas fa-receipt"></i> Despesas</div>
            <div class="tab" data-tab="report"><i class="fas fa-file-alt"></i> Relatório Financeiro</div>
        </div>
        
        <div id="report" class="tab-content">
            <!-- Conteúdo do relatório financeiro (mantido igual) -->
            <!-- ... -->
        </div>
        
        <div id="expenses" class="tab-content active">
            <div class="section">
                <h2 class="section-title"><i class="fas fa-plus-circle"></i> Registrar Nova Despesa</h2>
                
                <div id="expenseMessage" class="message"></div>
                
                <form id="expenseForm" class="expense-form">
                    <div class="form-group">
                        <label for="expenseDate">Data:</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseMonth">Mês/Ano de Referência:</label>
                        <input type="month" id="expenseMonth" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseValue">Valor (R$):</label>
                        <input type="number" id="expenseValue" step="0.01" min="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseCategory">Categoria:</label>
                        <select id="expenseCategory" required>
                            <option value="">Selecione uma categoria</option>
                            <option value="Mat. Esportivo">Mat. Esportivo</option>
                            <option value="Manutenção">Manutenção</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseDescription">Descrição:</label>
                        <textarea id="expenseDescription" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseReceipt">Comprovante (PDF ou imagem):</label>
                        <input type="file" id="expenseReceipt" accept=".pdf,.jpg,.jpeg,.png">
                        <div id="removeReceiptContainer" style="display: none; margin-top: 5px;">
                            <button type="button" id="removeReceiptBtn" class="btn-remove-receipt">
                                <i class="fas fa-trash-alt"></i> Remover Comprovante Atual
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center;">
                        <button type="submit" class="btn-submit">Registrar Despesa</button>
                        <button type="button" id="cancelEditBtn" class="btn-cancel" style="display: none;">Cancelar Edição</button>
                    </div>
                </form>
            </div>
            
            <div class="section">
                <h2 class="section-title"><i class="fas fa-history"></i> Últimas Despesas Registradas</h2>
                
                <div id="recentExpenses" class="expenses-list">
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
      © 2025 SMV Eletrônica- Todos os direitos reservados<br>
      <div class="footer-links">
        Powered by:
        <a href="https://github.com/seu-usuario" target="_blank" class="github-link">
          <i class="fab fa-github"></i> GitHub
        </a>
        <a href="https://firebase.google.com/" target="_blank" class="firebase-link">
          <i class="fas fa-fire"></i> Firebase
        </a>        
        <a href="https://onesignal.com/" target="_blank" class="onesignal-link">
        <img src="https://dashboard.onesignal.com/favicon/favicon-32x32.png" alt="OneSignal" style="height:12px; vertical-align:middle; margin-right:4px;">
        OneSignal      
        </a>
      </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, get, push, set, remove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";        
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAWMgLaPMpNOdPW10S-bVVEiQW-r3QCkxg",
            authDomain: "volei-25301.firebaseapp.com",
            databaseURL: "https://volei-25301-default-rtdb.firebaseio.com",
            projectId: "volei-25301",
            storageBucket: "volei-25301.firebasestorage.app",
            messagingSenderId: "1007197261034",
            appId: "1:1007197261034:web:f2c7ab9cb2793a694cdb93",
            measurementId: "G-CYMLX0SJJQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const storage = getStorage(app);

        // Elementos do DOM
        const yearFilter = document.getElementById('yearFilter');
        const monthFilter = document.getElementById('monthFilter');
        const financialData = document.getElementById('financialData');
        const defaultersList = document.getElementById('defaultersList');
        const logoutBtn = document.getElementById('logoutBtn');
        const expenseForm = document.getElementById('expenseForm');
        const expenseMessage = document.getElementById('expenseMessage');
        const recentExpenses = document.getElementById('recentExpenses');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const totalIncomeElement = document.getElementById('totalIncome');
        const totalReceivablesElement = document.getElementById('totalReceivables');
        const totalExpensesElement = document.getElementById('totalExpenses');
        const currentBalanceElement = document.getElementById('currentBalance');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const removeReceiptBtn = document.getElementById('removeReceiptBtn');
        const removeReceiptContainer = document.getElementById('removeReceiptContainer');

        let currentUserPlayer = null;

        const today = new Date();
        document.getElementById('expenseDate').valueAsDate = today;
        document.getElementById('expenseMonth').value = today.toISOString().slice(0, 7);

        // Função para carregar despesa no formulário de edição
        function loadExpenseIntoForm(expenseId, expenseData) {
            document.getElementById('expenseDate').value = expenseData.date || '';
            document.getElementById('expenseMonth').value = expenseData.month || '';
            document.getElementById('expenseValue').value = expenseData.value || '';
            document.getElementById('expenseCategory').value = expenseData.category || '';
            document.getElementById('expenseDescription').value = expenseData.description || '';
            
            // Adiciona um campo hidden para armazenar o ID da despesa sendo editada
            if (!document.getElementById('editingExpenseId')) {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.id = 'editingExpenseId';
                hiddenInput.value = expenseId;
                expenseForm.appendChild(hiddenInput);
            } else {
                document.getElementById('editingExpenseId').value = expenseId;
            }
            
            // Adiciona um campo hidden para armazenar o nome do comprovante atual (se existir)
            if (expenseData.receiptName && !document.getElementById('currentReceiptName')) {
                const receiptInput = document.createElement('input');
                receiptInput.type = 'hidden';
                receiptInput.id = 'currentReceiptName';
                receiptInput.value = expenseData.receiptName;
                expenseForm.appendChild(receiptInput);
            } else if (expenseData.receiptName) {
                document.getElementById('currentReceiptName').value = expenseData.receiptName;
            }
            
            // Mostra/oculta o botão de remover comprovante
            if (expenseData.receiptUrl) {
                removeReceiptContainer.style.display = 'block';
            } else {
                removeReceiptContainer.style.display = 'none';
            }
            
            // Muda o texto do botão para indicar que está editando
            document.querySelector('#expenseForm button[type="submit"]').textContent = 'Atualizar Despesa';
            cancelEditBtn.style.display = 'inline-block';
        }

        // Event listener para o botão de remover comprovante
        removeReceiptBtn.addEventListener('click', () => {
            document.getElementById('expenseReceipt').value = '';
            removeReceiptContainer.style.display = 'none';
            if (document.getElementById('currentReceiptName')) {
                document.getElementById('currentReceiptName').value = '';
            }
        });

        // Event listener para o botão de cancelar edição
        cancelEditBtn.addEventListener('click', () => {
            expenseForm.reset();
            document.getElementById('expenseDate').valueAsDate = new Date();
            document.getElementById('expenseMonth').value = today.toISOString().slice(0, 7);
            document.getElementById('expenseReceipt').value = '';
            
            const editingExpenseIdElement = document.getElementById('editingExpenseId');
            const currentReceiptNameElement = document.getElementById('currentReceiptName');
            if (editingExpenseIdElement) editingExpenseIdElement.remove();
            if (currentReceiptNameElement) currentReceiptNameElement.remove();
            
            document.querySelector('#expenseForm button[type="submit"]').textContent = 'Registrar Despesa';
            cancelEditBtn.style.display = 'none';
            removeReceiptContainer.style.display = 'none';
        });

        // Função para renderizar despesas recentes (com suporte a edição)
        function renderRecentExpenses(expenses) {
            recentExpenses.innerHTML = '';
            
            if (expenses.length === 0) {
                recentExpenses.innerHTML = '<div class="no-defaulters">Nenhuma despesa registrada ainda</div>';
                return;
            }
            
            expenses.forEach(expense => {
                const [year, month] = expense.month?.split('-') || [];
                const expenseDate = expense.date ? formatDate(expense.date) : formatDate(expense.createdAt);
                const createdBy = expense.createdByName || 'Não informado';
                const deletedBy = expense.isDeleted ? (expense.deletedByName || 'Não informado') : '';
                const deletedAt = expense.isDeleted && expense.deletedAt ? formatDate(expense.deletedAt) : '';
                const deletionReason = expense.isDeleted ? (expense.deletionReason || 'Não informado') : '';
                
                // Verifica se há comprovante e se não está deletado
                let receiptHtml = '';
                if (expense.receiptUrl && !expense.isDeleted) {
                    const isPDF = expense.receiptName?.toLowerCase().endsWith('.pdf') || false;
                    receiptHtml = `
                        <div style="margin-top: 5px;">
                            <strong>Comprovante:</strong> 
                            <a href="${expense.receiptUrl}" target="_blank" class="receipt-link">
                                ${isPDF ? '<i class="fas fa-file-pdf"></i>' : '<i class="fas fa-file-image"></i>'}
                                ${expense.receiptName || 'Comprovante'}
                            </a>
                        </div>
                    `;
                }
                
                const expenseEl = document.createElement('div');
                expenseEl.className = 'expense-item';
                expenseEl.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <strong>${expenseDate} - ${expenseCategoryName(expense.category)}</strong>
                        <span class="expense-value">R$ ${parseFloat(expense.value).toFixed(2)}</span>
                    </div>
                    <div style="color: #666; margin-bottom: 5px;">
                        ${expense.month ? `${getMonthName(month)}/${year}` : 'Sem mês de referência'}
                    </div>
                    <div style="margin-bottom: 5px;">Descrição: ${expense.description || 'Sem descrição'}</div>
                    <div style="margin-bottom: 5px;">Registrado por: ${createdBy}</div>
                    ${receiptHtml}
                    ${expense.isDeleted ? `
                        <div style="margin-bottom: 5px; color: #f44336;">
                            Cancelado por: ${deletedBy} em ${deletedAt}<br>
                            Justificativa: ${deletionReason}
                        </div>
                    ` : ''}
                    ${!expense.isDeleted ? `
                        <button class="delete-expense-btn" data-id="${expense.id}" style="margin-top: 10px; padding: 3px 8px; font-size: 12px; background-color: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer;">Cancelar</button>
                    ` : ''}
                `;
                
                // Adiciona evento de clique para edição (apenas se não estiver deletado)
                if (!expense.isDeleted) {
                    expenseEl.addEventListener('click', () => {
                        loadExpenseIntoForm(expense.id, expense);
                        // Rolagem suave até o formulário
                        document.getElementById('expenseForm').scrollIntoView({ behavior: 'smooth' });
                    });
                    
                    // Adiciona classe para indicar que é clicável
                    expenseEl.style.cursor = 'pointer';
                    expenseEl.classList.add('editable-expense');
                }
                
                recentExpenses.appendChild(expenseEl);
            });
            
            // Adiciona eventos aos botões de deletar
            document.querySelectorAll('.delete-expense-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Impede que o evento de clique na despesa seja acionado
                    deleteExpense(btn.getAttribute('data-id'));
                });
            });
        }

        // Função para deletar despesa (com remoção de comprovante)
        async function deleteExpense(expenseId) {
            const result = await Swal.fire({
                icon: 'warning',
                title: 'Confirmar Cancelamento',
                text: 'Por favor, informe o motivo do Cancelamento:',
                input: 'textarea',
                inputPlaceholder: 'Digite a justificativa aqui...',
                inputAttributes: {
                    required: true
                },
                showCancelButton: true,
                confirmButtonText: 'Confirmar',
                cancelButtonText: 'Sair',
                inputValidator: (value) => {
                    if (!value.trim()) {
                        return 'A justificativa é obrigatória!';
                    }
                }
            });
            
            if (!result.isConfirmed) return;
            
            try {
                const expenseRef = ref(database, `expenses/${expenseId}`);
                const deletedExpenseRef = ref(database, `deletedExpenses/${expenseId}`);
                const snapshot = await get(expenseRef);
                
                if (!snapshot.exists()) {
                    showMessage('Despesa não encontrada.', 'error', expenseMessage);
                    return;
                }
                
                const expenseData = snapshot.val();
                
                // Remove o comprovante se existir
                if (expenseData.receiptUrl) {
                    const filePath = `comprovantes/despesas/${expenseId}_${expenseData.receiptName}`;
                    const fileRef = storageRef(storage, filePath);
                    await deleteObject(fileRef);
                }
                
                expenseData.deletedByName = currentUserPlayer?.name || 'Usuário';
                expenseData.deletedAt = new Date().toISOString();
                expenseData.deletionReason = result.value;
                
                await Promise.all([
                    set(deletedExpenseRef, expenseData),
                    remove(expenseRef)
                ]);
                
                showMessage('Despesa cancelada com sucesso!', 'success', expenseMessage);
                loadFinancialData();
                loadRecentExpenses();
            } catch (error) {
                console.error("Error deleting expense:", error);
                showMessage('Erro ao cancelar despesa: ' + error.message, 'error', expenseMessage);
            }
        }

        // Event listener para o formulário de despesas (com suporte a edição)
        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const expenseData = {
                date: document.getElementById('expenseDate').value,
                month: document.getElementById('expenseMonth').value,
                value: parseFloat(document.getElementById('expenseValue').value),
                category: document.getElementById('expenseCategory').value,
                description: document.getElementById('expenseDescription').value,
                updatedAt: new Date().toISOString(),
                updatedByName: currentUserPlayer?.name || 'Usuário'
            };
            
            const receiptFile = document.getElementById('expenseReceipt').files[0];
            const editingExpenseId = document.getElementById('editingExpenseId')?.value;
            const currentReceiptName = document.getElementById('currentReceiptName')?.value;
            
            try {
                // Se estiver editando
                if (editingExpenseId) {
                    const expenseRef = ref(database, `expenses/${editingExpenseId}`);
                    const currentExpenseSnapshot = await get(expenseRef);
                    const currentExpenseData = currentExpenseSnapshot.val();
                    
                    // Se houver um novo arquivo ou se quisermos remover o existente
                    if (receiptFile || (currentExpenseData.receiptUrl && !receiptFile && !currentReceiptName)) {
                        // Remove o comprovante antigo se existir
                        if (currentExpenseData.receiptUrl) {
                            const oldFilePath = `comprovantes/despesas/${editingExpenseId}_${currentExpenseData.receiptName}`;
                            const oldFileRef = storageRef(storage, oldFilePath);
                            await deleteObject(oldFileRef);
                        }
                        
                        // Faz upload do novo comprovante se existir
                        if (receiptFile) {
                            const filePath = `comprovantes/despesas/${editingExpenseId}_${receiptFile.name}`;
                            const fileRef = storageRef(storage, filePath);
                            await uploadBytes(fileRef, receiptFile);
                            const downloadURL = await getDownloadURL(fileRef);
                            expenseData.receiptUrl = downloadURL;
                            expenseData.receiptName = receiptFile.name;
                        } else {
                            // Remove a referência ao comprovante se não houver novo arquivo
                            expenseData.receiptUrl = null;
                            expenseData.receiptName = null;
                        }
                    }
                    
                    await set(expenseRef, { ...currentExpenseData, ...expenseData });
                    showMessage('Despesa atualizada com sucesso!', 'success', expenseMessage);
                } 
                // Se for uma nova despesa
                else {
                    const newExpenseRef = push(ref(database, 'expenses'));
                    expenseData.createdAt = new Date().toISOString();
                    expenseData.createdByName = currentUserPlayer?.name || 'Usuário';
                    
                    if (receiptFile) {
                        const filePath = `comprovantes/despesas/${newExpenseRef.key}_${receiptFile.name}`;
                        const fileRef = storageRef(storage, filePath);
                        await uploadBytes(fileRef, receiptFile);
                        const downloadURL = await getDownloadURL(fileRef);
                        expenseData.receiptUrl = downloadURL;
                        expenseData.receiptName = receiptFile.name;
                    }
                    
                    await set(newExpenseRef, expenseData);
                    showMessage('Despesa registrada com sucesso!', 'success', expenseMessage);
                }
                
                // Limpa o formulário
                expenseForm.reset();
                document.getElementById('expenseDate').valueAsDate = new Date();
                document.getElementById('expenseMonth').value = today.toISOString().slice(0, 7);
                document.getElementById('expenseReceipt').value = '';
                
                // Remove os campos hidden se existirem
                const editingExpenseIdElement = document.getElementById('editingExpenseId');
                const currentReceiptNameElement = document.getElementById('currentReceiptName');
                if (editingExpenseIdElement) editingExpenseIdElement.remove();
                if (currentReceiptNameElement) currentReceiptNameElement.remove();
                
                // Restaura o texto do botão e oculta o botão de cancelar
                document.querySelector('#expenseForm button[type="submit"]').textContent = 'Registrar Despesa';
                cancelEditBtn.style.display = 'none';
                removeReceiptContainer.style.display = 'none';
                
                // Atualiza as listas
                loadFinancialData();
                loadRecentExpenses();
                
            } catch (error) {
                console.error("Error saving expense:", error);
                showMessage('Erro ao salvar despesa: ' + error.message, 'error', expenseMessage);
            }
        });

        // ... (restante do código existente - loadFinancialData, loadDefaulters, etc.)
        // As outras funções podem permanecer exatamente como estão no seu código original

        // Funções auxiliares
        function getMonthName(monthNumber) {
            const months = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            return months[parseInt(monthNumber) - 1];
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            
            const date = new Date(dateString);
            const offset = date.getTimezoneOffset() * 60000;
            const adjustedDate = new Date(date.getTime() + offset);
            
            return adjustedDate.toLocaleDateString('pt-BR');
        }
        
        function expenseCategoryName(category) {
            return category || 'Sem categoria';
        }
        
        function showMessage(message, type, element) {
            element.textContent = message;
            element.className = `message ${type}`;
            element.style.display = 'block';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // Inicialização
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'loginvl.html';
                return;
            }

            try {
                const authorizedEmailsRef = ref(database, 'authorizedEmails');
                const snapshot = await get(authorizedEmailsRef);
                
                let isAuthorized = false;
                if (snapshot.exists()) {
                    const authorizedEmails = snapshot.val();
                    const transformedEmail = user.email.replace('.', ',');
                    isAuthorized = authorizedEmails[transformedEmail] === true;
                }

                if (!isAuthorized) {
                    window.location.href = 'lista.html';
                    return;
                }

                document.getElementById('userEmail').textContent = `Logado como: ${user.email}`;
                await loadCurrentUserPlayer(user.email);
                loadFinancialData();
                loadDefaulters();
                loadRecentExpenses();
            } catch (error) {
                console.error('Error during authorization check:', error);
                await Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao verificar autorização: ' + error.message,
                    timer: 3500,
                    showConfirmButton: false,
                }).then(() => {
                    window.location.href = 'lista.html';
                });
            }
        });

        // ... (restante do código de inicialização e configuração)
    </script>
</body>
</html>
