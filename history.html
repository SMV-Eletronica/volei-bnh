<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Histórico de Jogos - Vôlei BNH</title>
  <link rel="stylesheet" href="history.css?v=2.5">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://moment.github.io/luxon/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>

    
  </style>
</head>
<body>
  <div class="header">
    <button class="menu-toggle" id="menuToggle" style="font-size: 11px;">
      <i class="fas fa-bars" style="font-size: 20px;"></i><br><strong>Menu</strong>
    </button>
    <center><h2><i class="fas fa-history"></i> Histórico de Jogos</h2></center>
  </div>
  
  <div class="sidebar" id="sidebar">
    <div class="sidebar-menu">
      <div class="user-profile">
        <img id="sidebarUserPhoto" class="sidebar-user-photo" src="" alt="Foto do usuário">
        <div class="sidebar-user-info">
          <div id="sidebarUserName" class="sidebar-user-name"></div>
          <div id="sidebarUserPosition" class="sidebar-user-position"></div>
          <div id="userEmail" class="sidebar-user-position"></div>
        </div>
      </div>
      
      <button class="logout-btn" onclick="window.location.href='transparencia.html'"><i class="fas fa-hand-holding-usd"></i> Transparência</button>
      <button class="logout-btn" onclick="window.location.href='enquete.html'"><i class="fas fa-question-circle"></i> Enquetes</button>
      <button class="logout-btn" onclick="window.location.href='lista.html'"><i class="fas fa-list"></i> Jogos</button>
    </div>
    <button id="logoutBtn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Sair</button>
  </div>
  
  <div class="overlay" id="overlay"></div>
  
  <div class="container">
    <div class="filter-container">
      <div>
        <label for="yearFilter">Ano:</label>
        <select id="yearFilter" class="filter-select">
          <option value="">Todos</option>
        </select>
      </div>
      <div>
        <label for="monthFilter">Mês:</label>
        <select id="monthFilter" class="filter-select">
          <option value="">Todos</option>
          <option value="01">Janeiro</option>
          <option value="02">Fevereiro</option>
          <option value="03">Março</option>
          <option value="04">Abril</option>
          <option value="05">Maio</option>
          <option value="06">Junho</option>
          <option value="07">Julho</option>
          <option value="08">Agosto</option>
          <option value="09">Setembro</option>
          <option value="10">Outubro</option>
          <option value="11">Novembro</option>
          <option value="12">Dezembro</option>
        </select>
      </div>
      <div>
        <label for="playerFilter">Meus Jogos:</label>
        <select id="playerFilter" class="filter-select">
          <option value="all">Todos os jogos</option>
          <option value="mine">Somente meus jogos</option>
        </select>
      </div>
      <button id="applyFilters" class="filter-btn"><i class="fas fa-filter"></i> Aplicar Filtros</button>
    </div>
    
    <div id="historyList"></div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWMgLaPMpNOdPW10S-bVVEiQW-r3QCkxg",
      authDomain: "volei-25301.firebaseapp.com",
      databaseURL: "https://volei-25301-default-rtdb.firebaseio.com",
      projectId: "volei-25301",
      storageBucket: "volei-25301.firebasestorage.app",
      messagingSenderId: "1007197261034",
      appId: "1:1007197261034:web:f2c7ab9cb2793a694cdb93",
      measurementId: "G-CYMLX0SJJQ"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth(app);
    
    const { DateTime } = luxon;
    luxon.Settings.defaultLocale = 'pt-BR';
    
    let currentUser = null;
    let currentUserPlayer = null;
    let allPlayers = [];
    
    // Elementos da página
    const historyList = document.getElementById('historyList');
    const yearFilter = document.getElementById('yearFilter');
    const monthFilter = document.getElementById('monthFilter');
    const playerFilter = document.getElementById('playerFilter');
    const applyFilters = document.getElementById('applyFilters');
    
    // Menu toggle
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    
    function toggleSidebar() {
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }
    
    menuToggle.addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', toggleSidebar);
    
    // Carregar dados do usuário
    async function loadCurrentUser() {
      try {
        const playersRef = ref(database, 'players');
        const snapshot = await get(playersRef);
        
        if (snapshot.exists()) {
          allPlayers = Object.entries(snapshot.val()).map(([id, player]) => ({
            id,
            ...player
          }));
          
          currentUserPlayer = allPlayers.find(player => player.email === currentUser.email);
          
          if (currentUserPlayer) {
            document.getElementById('sidebarUserName').textContent = currentUserPlayer.name;
            document.getElementById('sidebarUserPosition').textContent = currentUserPlayer.position || 'Posição não definida';
            document.getElementById('userEmail').textContent = currentUser.email;
            
            if (currentUserPlayer.imageUrl) {
              document.getElementById('sidebarUserPhoto').src = currentUserPlayer.imageUrl;
            }
          }
        }
      } catch (error) {
        console.error('Erro ao carregar dados do usuário:', error);
      }
    }
    
    // Carregar anos disponíveis
    async function loadAvailableYears() {
      try {
        const historyRef = ref(database, 'gameHistory');
        const snapshot = await get(historyRef);
        
        yearFilter.innerHTML = '<option value="">Todos</option>';
        
        if (snapshot.exists()) {
          const years = Object.keys(snapshot.val()).sort((a, b) => b - a);
          years.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearFilter.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Erro ao carregar anos:', error);
      }
    }
    
    // Carregar histórico de jogos
    async function loadGameHistory(filters = {}) {
      try {
        historyList.innerHTML = '<p>Carregando histórico...</p>';
        
        let historyQuery;
        
        if (filters.year && filters.month) {
          // Filtrar por ano e mês específicos
          historyQuery = ref(database, `gameHistory/${filters.year}/${filters.month}`);
        } else if (filters.year) {
          // Filtrar apenas por ano
          historyQuery = ref(database, `gameHistory/${filters.year}`);
        } else {
          // Carregar todo o histórico
          historyQuery = ref(database, 'gameHistory');
        }
        
        const snapshot = await get(historyQuery);
        
        if (!snapshot.exists()) {
          historyList.innerHTML = '<p>Nenhum jogo encontrado no histórico.</p>';
          return;
        }
        
        let games = [];
        
        // Processar dados do snapshot
        const data = snapshot.val();
        if (filters.year && filters.month) {
          // Já estamos no nível do mês
          Object.entries(data).forEach(([gameId, gameData]) => {
            games.push({
              id: gameId,
              ...gameData
            });
          });
        } else if (filters.year) {
          // Estamos no nível do ano, precisamos percorrer os meses
          Object.entries(data).forEach(([month, monthGames]) => {
            Object.entries(monthGames).forEach(([gameId, gameData]) => {
              games.push({
                id: gameId,
                ...gameData
              });
            });
          });
        } else {
          // Estamos na raiz, precisamos percorrer anos e meses
          Object.entries(data).forEach(([year, yearData]) => {
            Object.entries(yearData).forEach(([month, monthGames]) => {
              Object.entries(monthGames).forEach(([gameId, gameData]) => {
                games.push({
                  id: gameId,
                  ...gameData
                });
              });
            });
          });
        }
        
        // Ordenar jogos por data (mais recente primeiro)
        games.sort((a, b) => {
          const dateA = new Date(`${a.date}T${a.time}`);
          const dateB = new Date(`${b.date}T${b.time}`);
          return dateB - dateA;
        });
        
        // Aplicar filtro de jogador se necessário
        if (filters.onlyMyGames && currentUserPlayer) {
          const myGames = [];
          
          for (const game of games) {
            const confirmedIds = Object.keys(game.confirmedPlayers || {});
            const waitlistIds = Object.keys(game.waitlistPlayers || {});
          
            if (confirmedIds.includes(currentUserPlayer.id)) {
              myGames.push({ ...game, myStatus: 'confirmed' });
            } else if (waitlistIds.includes(currentUserPlayer.id)) {
              myGames.push({ ...game, myStatus: 'waitlist' });
            }
          }
          
          games = myGames;
        }
        
        // Exibir jogos
        if (games.length === 0) {
          historyList.innerHTML = '<p>Nenhum jogo encontrado com os filtros selecionados.</p>';
          return;
        }
        
        historyList.innerHTML = '';
        
        for (const game of games) {
          const gameDate = DateTime.fromISO(game.date, { zone: 'America/Sao_Paulo' });
          const formattedDate = gameDate.toFormat('dd/MM/yyyy');
          const formattedTime = DateTime.fromISO(`2000-01-01T${game.time}`).toFormat('HH:mm');
          const dayOfWeek = gameDate.toFormat('EEEE', { locale: 'pt-BR' });
          
          const gameCard = document.createElement('div');
          gameCard.className = 'game-card';
          
          let headerHtml = `
            <div class="game-header">
              <h3>${formattedDate} - ${dayOfWeek} às ${formattedTime}</h3>
              <span>${Object.keys(game.confirmedPlayers || {}).length}/${game.playerLimit} jogadores</span>
          `;
          
          if (game.myStatus) {
            headerHtml += `<span class="my-status">(${game.myStatus === 'confirmed' ? 'Participou' : 'Lista de espera'})</span>`;
          }
          
          headerHtml += `</div>`;
          
          let playersHtml = '<div class="player-list">';
          
          // Adicionar jogadores confirmados
          const confirmedPlayers = Object.values(game.confirmedPlayers || {});
          if (confirmedPlayers.length > 0) {
            playersHtml += '<h4>Jogadores Confirmados:</h4>';
            
            for (const player of confirmedPlayers) {
              const playerData = allPlayers.find(p => p.id === player.id) || player;
              playersHtml += `
                <div class="player-item">
                  <img src="${playerData.imageUrl || defaultImage}" alt="${playerData.name}" class="player-photo">
                  <div>
                    <strong>${playerData.name}</strong>
                    <div>${playerData.position || 'Posição não definida'} - ${playerData.category || 'CONVIDADO'}</div>
                  </div>
                </div>
              `;
            }
          }
          
          // Adicionar lista de espera se houver
          const waitlistPlayers = Object.values(game.waitlistPlayers || {});
          if (waitlistPlayers.length > 0) {
            playersHtml += '<h4>Lista de Espera:</h4>';
            
            for (const player of waitlistPlayers) {
              const playerData = allPlayers.find(p => p.id === player.id) || player;
              playersHtml += `
                <div class="player-item">
                  <img src="${playerData.imageUrl || defaultImage}" alt="${playerData.name}" class="player-photo">
                  <div>
                    <strong>${playerData.name}</strong>
                    <div>${playerData.position || 'Posição não definida'} - ${playerData.category || 'CONVIDADO'}</div>
                  </div>
                </div>
              `;
            }
          }
          
          playersHtml += '</div>';
          gameCard.innerHTML = headerHtml + playersHtml;
          historyList.appendChild(gameCard);
        }
      } catch (error) {
        console.error('Erro ao carregar histórico:', error);
        historyList.innerHTML = '<p>Ocorreu um erro ao carregar o histórico de jogos.</p>';
      }
    }
    
    // Configurar filtros
    applyFilters.addEventListener('click', () => {
      const filters = {
        year: yearFilter.value,
        month: monthFilter.value,
        onlyMyGames: playerFilter.value === 'mine'
      };
      
      loadGameHistory(filters);
    });
    
    // Inicializar a página
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'loginvl.html';
        return;
      }
      
      currentUser = user;
      await loadCurrentUser();
      await loadAvailableYears();
      loadGameHistory();
    });
  </script>
</body>
</html>
