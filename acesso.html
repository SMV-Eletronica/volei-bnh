<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Acessos - Vôlei BNH</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="lista.css">
  <style>
    .access-log-container {
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    .access-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .access-table th, .access-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .access-table th {
      background-color: #f2f2f2;
    }
    .filter-container {
      margin-bottom: 20px;
    }
    .filter-container input, .filter-container button {
      padding: 8px;
      margin-right: 10px;
    }
    .delete-btn {
      padding: 8px;
      background-color: #ff4444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .delete-btn:hover {
      background-color: #cc0000;
    }
  </style>
</head>
<body>
  <div class="header">
    <button class="menu-toggle" id="menuToggle" style="font-size: 11px;">
      <i class="fas fa-bars" style="font-size: 20px;"></i><br><strong>Menu</strong>
    </button>
    <center><h2><i class="fas fa-volleyball-ball"></i> Vôlei-BNH</h2></center>
  </div>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-menu">
      <div class="user-profile">
        <img id="sidebarUserPhoto" class="sidebar-user-photo" src="" alt="Foto do usuário">
        <div class="sidebar-user-info">
          <div id="sidebarUserName" class="sidebar-user-name"></div>
          <div id="sidebarUserPosition" class="sidebar-user-position"></div>
          <div id="userEmail" class="sidebar-user-position"></div>
        </div>
      </div>
      <button id="transparenciaBtn" class="logout-btn" onclick="window.location.href='transparencia.html'"><i class="fas fa-hand-holding-usd"></i> Transparência</button>
      <button class="logout-btn" onclick="window.location.href='enquete.html'"><i class="fas fa-question-circle"></i> Enquetes</button>
      <button id="listaBtn" class="logout-btn" onclick="window.location.href='lista.html'"><i class="fas fa-list"></i> Jogos</button>
      <button id="adminBtn" class="logout-btn" onclick="window.location.href='dashboard.html'"><i class="fas fa-cogs"></i> Administração</button>
    </div>
    <button id="logoutBtn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Sair</button>
  </div>
  <div class="overlay" id="overlay"></div>

  <div class="access-log-container">
    <h2><i class="fas fa-history"></i> Registro de Acessos</h2>
    <div class="filter-container">
      <input type="text" id="userSearch" placeholder="Filtrar por nome">
      <input type="date" id="dateFilter">
      <button id="applyFilters"><i class="fas fa-filter"></i> Filtrar</button>
      <button id="deleteFiltered" class="delete-btn"><i class="fas fa-trash-alt"></i> Excluir Filtrados</button>
    </div>
    <table class="access-table">
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Nome do Usuário</th>
        </tr>
      </thead>
      <tbody id="accessList"></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, get, remove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWMgLaPMpNOdPW10S-bVVEiQW-r3QCkxg",
      authDomain: "volei-25301.firebaseapp.com",
      databaseURL: "https://volei-25301-default-rtdb.firebaseio.com",
      projectId: "volei-25301",
      storageBucket: "volei-25301.firebasestorage.app",
      messagingSenderId: "1007197261034",
      appId: "1:1007197261034:web:f2c7ab9cb2793a694cdb93",
      measurementId: "G-CYMLX0SJJQ"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth(app);

    const adminEmails = ['mvvasques@msn.com', 'fabioluiztx@outlook.com', 'evandroAsyncronousFunctionCall@msn.com'];
    let emailLogado = null;
    let currentFilteredActivities = []; // Armazena os registros atualmente filtrados

    // Função para abrir/fechar o menu lateral
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    function toggleSidebar() {
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }
    menuToggle.addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', toggleSidebar);

    // Verificar autenticação
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        await Swal.fire({
          icon: 'error',
          title: 'Acesso Negado',
          text: 'Você precisa estar logado para acessar esta página.',
        });
        window.location.href = 'loginvl.html';
      } else {
        emailLogado = user.email;
        document.getElementById('userEmail').textContent = `${user.email}`;
        if (!adminEmails.includes(emailLogado)) {
          await Swal.fire({
            icon: 'error',
            title: 'Acesso Negado',
            text: 'Apenas administradores podem acessar o registro de acessos.',
          });
          window.location.href = 'lista.html';
        } else {
          await loadAccessLogs();
        }
      }
    });

    // Função para carregar registros de acesso
    async function loadAccessLogs() {
      try {
        const activitiesRef = ref(database, 'userActivity');
        const snapshot = await get(activitiesRef);
        let activities = [];
        if (snapshot.exists()) {
          const years = snapshot.val() || {};
          for (const year in years) {
            for (const month in years[year]) {
              const monthActivities = years[year][month] || {};
              activities.push(
                ...Object.entries(monthActivities).map(([id, activity]) => ({
                  id,
                  ...activity,
                  year,
                  month
                }))
              );
            }
          }
        }
        activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        displayAccessLogs(activities);
      } catch (error) {
        console.error('Erro ao carregar registros de acesso:', error);
        Swal.fire({
          icon: 'error',
          title: 'Erro',
          text: 'Não foi possível carregar os registros de acesso.',
        });
      }
    }

    // Função para exibir registros de acesso
    function displayAccessLogs(activities) {
      currentFilteredActivities = activities; // Atualiza os registros filtrados atuais
      const accessList = document.getElementById('accessList');
      accessList.innerHTML = '';
      activities.forEach(activity => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${new Date(activity.timestamp).toLocaleString('pt-BR')}</td>
          <td>${activity.userName}</td>
        `;
        accessList.appendChild(row);
      });
    }

    // Aplicar filtros
    document.getElementById('applyFilters').addEventListener('click', async () => {
      const userSearch = document.getElementById('userSearch').value.trim().toLowerCase();
      const dateFilter = document.getElementById('dateFilter').value;

      try {
        const activitiesRef = ref(database, 'userActivity');
        const snapshot = await get(activitiesRef);
        let activities = [];
        if (snapshot.exists()) {
          const years = snapshot.val() || {};
          for (const year in years) {
            for (const month in years[year]) {
              const monthActivities = years[year][month] || {};
              activities.push(
                ...Object.entries(monthActivities).map(([id, activity]) => ({
                  id,
                  ...activity,
                  year,
                  month
                }))
              );
            }
          }
        }
        activities = activities.filter(activity => {
          const matchesUser = userSearch ? activity.userName.toLowerCase().includes(userSearch) : true;
          const matchesDate = dateFilter ? activity.timestamp.startsWith(dateFilter) : true;
          return matchesUser && matchesDate;
        });
        activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        displayAccessLogs(activities);
      } catch (error) {
        console.error('Erro ao aplicar filtros:', error);
        Swal.fire({
          icon: 'error',
          title: 'Erro',
          text: 'Erro ao aplicar filtros.',
        });
      }
    });

    // Excluir registros filtrados
    document.getElementById('deleteFiltered').addEventListener('click', async () => {
      if (currentFilteredActivities.length === 0) {
        await Swal.fire({
          icon: 'warning',
          title: 'Nada para excluir',
          text: 'Não há registros filtrados para excluir.',
        });
        return;
      }

      const result = await Swal.fire({
        title: 'Tem certeza?',
        text: `Você está prestes a excluir ${currentFilteredActivities.length} registro(s). Esta ação não pode ser desfeita!`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sim, excluir!',
        cancelButtonText: 'Cancelar'
      });

      if (result.isConfirmed) {
        try {
          // Excluir cada registro filtrado
          for (const activity of currentFilteredActivities) {
            const activityRef = ref(database, `userActivity/${activity.year}/${activity.month}/${activity.id}`);
            await remove(activityRef);
          }

          await Swal.fire({
            icon: 'success',
            title: 'Excluído!',
            text: `Os ${currentFilteredActivities.length} registro(s) foram excluídos com sucesso.`,
            timer: 2000,
            showConfirmButton: false
          });

          // Recarregar a lista após exclusão
          await loadAccessLogs();
        } catch (error) {
          console.error('Erro ao excluir registros:', error);
          await Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: 'Ocorreu um erro ao tentar excluir os registros.',
          });
        }
      }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await signOut(auth);
        localStorage.removeItem(`lastAccess_${auth.currentUser?.uid}`); // Limpar localStorage
        await Swal.fire({
          icon: 'success',
          title: 'Logout',
          text: 'Você saiu com sucesso.',
          timer: 1500,
          showConfirmButton: false,
        });
        window.location.assign('loginvl.html');
      } catch (error) {
        console.error('Erro ao fazer logout:', error);
        Swal.fire({
          icon: 'error',
          title: 'Erro',
          text: 'Não foi possível fazer logout.',
        });
      }
    });
  </script>
</body>
</html>
