<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro Público - Vôlei-BNH</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .header h2 {
            margin: 0;
            padding: 0.5rem 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .header i {
            color: #3498db;
        }
        
        .admin-access {
            text-align: center;
            margin: 1rem 0;
        }
        
        .admin-access button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .admin-access button:hover {
            background-color: #2980b9;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1rem;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: #3498db;
            font-weight: bold;
        }
        
        .tab i {
            margin-right: 8px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section {
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            margin-bottom: 1rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .filter-controls div {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-controls label {
            font-weight: 600;
        }
        
        .filter-controls select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .cash-summary {
            margin-bottom: 2rem;
        }
        
        .cash-summary h3 {
            margin-bottom: 1rem;
            color: #2c3e50;
        }
        
        .cash-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .cash-summary-item {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .cash-summary-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .cash-summary-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .positive {
            color: #2ecc71;
        }
        
        .negative {
            color: #e74c3c;
        }
        
        table {
             width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 0.9rem;
        }
        
        table th, table td {
             border: 1px solid #ddd;
        padding: 6px;
        text-align: left;
        }
        
        table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        table tr:hover {
            background-color: #f5f5f5;
        }
        
        .status-pago {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .status-inadimplente {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .defaulters-section h3 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .defaulters-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .defaulter-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .defaulter-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .defaulter-info {
            flex: 1;
        }
        
        .defaulter-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .defaulter-months {
            font-size: 0.9rem;
            color: #666;
        }
        
        .no-defaulters {
            padding: 1rem;
            text-align: center;
            color: #666;
            font-style: italic;
        }
        
        .expense-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn-submit {
            grid-column: 1 / -1;
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-submit:hover {
            background-color: #2980b9;
        }
        
        .expenses-list {
            display: grid;
            gap: 1rem;
        }
        
        .expense-item {
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .expense-value {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .message {
            padding: 10px 15px;
            margin-bottom: 1rem;
            border-radius: 4px;
            display: none;
        }
        
        .error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        
        .success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }
        
        @media (max-width: 768px) {
            .filter-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .cash-summary-grid {
                grid-template-columns: 1fr;
            }
            
            .defaulters-list {
                grid-template-columns: 1fr;
            }
            
            .expense-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h2><i class="fas fa-volleyball-ball"></i> Vôlei-BNH </h2>
    </div>
    
    <div class="admin-access">
        <button onclick="window.location.href='index.html'">
            <i class="fas fa-lock"></i> Acesso Restrito
        </button>
    </div>
    
    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="report"><i class="fas fa-file-alt"></i> Relatório Financeiro</div>
        </div>
        
        <div id="report" class="tab-content active">
            <div class="section">
                <h2 class="section-title"><i class="fas fa-chart-pie"></i> Resumo Financeiro</h2>
                
                <div class="filter-controls">
                    <div>
                        <label for="yearFilter">Ano:</label>
                        <select id="yearFilter">
                            <option value="all">Todos</option>                            
                        </select>
                    </div>
                    <div>
                        <label for="monthFilter">Mês:</label>
                        <select id="monthFilter">
                            <option value="all">Todos</option>
                            <option value="01">Janeiro</option>
                            <option value="02">Fevereiro</option>
                            <option value="03">Março</option>
                            <option value="04">Abril</option>
                            <option value="05">Maio</option>
                            <option value="06">Junho</option>
                            <option value="07">Julho</option>
                            <option value="08">Agosto</option>
                            <option value="09">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                    </div>
                </div>
                
                <!-- Resumo do Caixa -->
                <div id="cashSummary" class="cash-summary">
                    <h3>Resumo do Caixa</h3>
                    <div class="cash-summary-grid">
                        <div class="cash-summary-item">
                            <div class="cash-summary-title">Total Receitas</div>
                            <div id="totalIncome" class="cash-summary-value">R$ 0,00</div>
                        </div>
                        <div class="cash-summary-item">
                            <div class="cash-summary-title">Total Despesas</div>
                            <div id="totalExpenses" class="cash-summary-value">R$ 0,00</div>
                        </div>
                        <div class="cash-summary-item">
                            <div class="cash-summary-title">Saldo Atual</div>
                            <div id="currentBalance" class="cash-summary-value">R$ 0,00</div>
                        </div>
                    </div>
                </div>
                
                <div id="financialSummary">
                    <table>
                        <thead>
                            <tr>
                                <th>Mês/Ano</th>
                                <th>Receitas (R$)</th>
                                <th>Despesas (R$)</th>
                                <th>Saldo (R$)</th>
                            </tr>
                        </thead>
                        <tbody id="financialData">
                            <!-- Os dados serão inseridos aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAWMgLaPMpNOdPW10S-bVVEiQW-r3QCkxg",
            authDomain: "volei-25301.firebaseapp.com",
            databaseURL: "https://volei-25301-default-rtdb.firebaseio.com",
            projectId: "volei-25301",
            storageBucket: "volei-25301.firebasestorage.app",
            messagingSenderId: "1007197261034",
            appId: "1:1007197261034:web:f2c7ab9cb2793a694cdb93",
            measurementId: "G-CYMLX0SJJQ"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Elementos DOM
        const yearFilter = document.getElementById('yearFilter');
        const monthFilter = document.getElementById('monthFilter');
        const financialData = document.getElementById('financialData');
        const totalIncomeElement = document.getElementById('totalIncome');
        const totalExpensesElement = document.getElementById('totalExpenses');
        const currentBalanceElement = document.getElementById('currentBalance');

        // Configurar abas
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // Carregar dados ao iniciar
        loadFinancialData();

        // Carregar dados financeiros
        async function loadFinancialData() {
            const currentSelectedYear = yearFilter.value;
            const currentSelectedMonth = monthFilter.value;
            yearFilter.disabled = true;
            
            const paymentsRef = ref(database, 'payments');
            const expensesRef = ref(database, 'expenses');
            
            try {
                const [paymentsSnapshot, expensesSnapshot] = await Promise.all([
                    get(paymentsRef),
                    get(expensesRef)
                ]);
                
                const payments = paymentsSnapshot.val() || {};
                const expenses = expensesSnapshot.val() || {};
                const monthlyData = {};
                const years = new Set();
                
                // Variáveis para o resumo do caixa
                let filteredIncome = 0;
                let filteredExpenses = 0;
                
                // Processar pagamentos
                Object.values(payments).forEach(payment => {
                    if (!payment.month || payment.value === undefined) return;
                    
                    const [year, month] = payment.month.split('-');
                    years.add(year);
                    
                    // Aplicar filtros
                    const matchesYear = currentSelectedYear === 'all' || year === currentSelectedYear;
                    const matchesMonth = currentSelectedMonth === 'all' || month === currentSelectedMonth;
                    
                    if (!matchesYear || !matchesMonth) return;
                    
                    const monthKey = `${year}-${month}`;
                    const monthName = getMonthName(month);
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            monthName,
                            year,
                            month,
                            income: 0,
                            expenses: 0,
                            paymentsCount: 0,
                            lateCount: 0
                        };
                    }
                    
                    const paymentValue = parseFloat(payment.value) || 0;
                    
                    monthlyData[monthKey].income += paymentValue;
                    monthlyData[monthKey].paymentsCount++;
                    filteredIncome += paymentValue;
                });
                
                // Processar despesas
                Object.values(expenses).forEach(expense => {
                    if (!expense.month || expense.value === undefined) return;
                    
                    const [year, month] = expense.month.split('-');
                    years.add(year);
                    
                    // Aplicar filtros
                    const matchesYear = currentSelectedYear === 'all' || year === currentSelectedYear;
                    const matchesMonth = currentSelectedMonth === 'all' || month === currentSelectedMonth;
                    
                    if (!matchesYear || !matchesMonth) return;
                    
                    const monthKey = `${year}-${month}`;
                    
                    if (!monthlyData[monthKey]) {
                        const monthName = getMonthName(month);
                        monthlyData[monthKey] = {
                            monthName,
                            year,
                            month,
                            income: 0,
                            expenses: 0,
                            paymentsCount: 0,
                            lateCount: 0
                        };
                    }
                    
                    const expenseValue = parseFloat(expense.value) || 0;
                    monthlyData[monthKey].expenses += expenseValue;
                    filteredExpenses += expenseValue;
                });
                
                // Atualizar filtro de anos
                updateYearFilterOptions(Array.from(years).sort().reverse());
                
                // Atualizar resumo do caixa com os valores filtrados
                updateCashSummary(filteredIncome, filteredExpenses);
                
                // Renderizar dados
                renderFinancialData(monthlyData);
                
            } catch (error) {
                console.error("Error loading financial data: ", error);
                financialData.innerHTML = '<tr><td colspan="4" style="text-align:center;">Erro ao carregar dados financeiros</td></tr>';
            } finally {
                yearFilter.disabled = false;
            }
        }

        // Atualizar opções do filtro de ano
        function updateYearFilterOptions(years) {
            const currentSelectedYear = yearFilter.value;
    
            yearFilter.innerHTML = '<option value="all">Todos</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
    
            if (currentSelectedYear !== 'all' && years.includes(currentSelectedYear)) {
                yearFilter.value = currentSelectedYear;
            } else {
                yearFilter.value = 'all';
            }
        }

        // Atualizar resumo do caixa
        function updateCashSummary(income, expenses) {
            const balance = income - expenses;
            
            totalIncomeElement.textContent = `R$ ${income.toFixed(2)}`;
            totalExpensesElement.textContent = `R$ ${expenses.toFixed(2)}`;
            
            currentBalanceElement.textContent = `R$ ${Math.abs(balance).toFixed(2)}`;
            currentBalanceElement.className = `cash-summary-value ${balance >= 0 ? 'positive' : 'negative'}`;
            
            if (balance < 0) {
                currentBalanceElement.textContent = `-R$ ${Math.abs(balance).toFixed(2)}`;
            }
        }

        // Renderizar dados financeiros
        function renderFinancialData(monthlyData) {
            const selectedYear = yearFilter.value;
            const selectedMonth = monthFilter.value;
            const sortedMonths = Object.keys(monthlyData).sort().reverse();
            
            financialData.innerHTML = '';
            
            if (sortedMonths.length === 0) {
                financialData.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhum dado disponível para o período selecionado</td></tr>';
                return;
            }
            
            sortedMonths.forEach(monthKey => {
                const data = monthlyData[monthKey];
                
                // Aplicar filtros
                if (selectedYear !== 'all' && data.year !== selectedYear) return;
                if (selectedMonth !== 'all' && data.month !== selectedMonth) return;
                
                const balance = data.income - data.expenses;
                const balanceClass = balance >= 0 ? 'status-pago' : 'status-inadimplente';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.monthName} ${data.year}</td>
                    <td>R$ ${data.income.toFixed(2)}</td>
                    <td>R$ ${data.expenses.toFixed(2)}</td>
                    <td class="${balanceClass}">R$ ${balance.toFixed(2)}</td>
                `;
                financialData.appendChild(row);
            });
        }

        // Helper functions
        function getMonthName(monthNumber) {
            const months = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            return months[parseInt(monthNumber) - 1];
        }

        // Listeners para filtros
        yearFilter.addEventListener('change', () => {
            loadFinancialData();
        });
        
        monthFilter.addEventListener('change', () => {
            loadFinancialData();
        });
    </script>
</body>
</html>
