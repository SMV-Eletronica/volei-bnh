<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Presença - Vôlei BNH</title>
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="header">
        <center><h2><i class="fas fa-volleyball-ball" style="color:#3498db;"></i> Vôlei-BNH Gestão</h2></center>
        <div class="button-container">
            <button onclick="window.location.href='dashboard.html'"><i class="fas fa-user-plus"></i> Cadastro</button>
            <button onclick="window.location.href='mensalidade.html'"><i class="fas fa-hand-holding-usd"></i> Contribuições</button>
            <button onclick="window.location.href='financeiro8.html'"><i class="fas fa-chart-line"></i> Financeiro</button>
            <button onclick="window.location.href='integrantes.html'"><i class="fas fa-users"></i> Integrantes</button>
            <button id="logoutBtn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </div>
    </div>

    <div class="container mx-auto p-4">
        <div id="userEmail" class="text-gray-700 mb-4"></div>

        <!-- Seção de Criação de Evento -->
        <div id="eventCreation" class="bg-white p-6 rounded-lg shadow-md mb-6" style="display: none;">
            <h2 class="text-2xl font-bold mb-4"><i class="fas fa-calendar-plus"></i> Criar Evento</h2>
            <form id="eventForm">
                <div class="mb-4">
                    <label class="block text-gray-700">Data do Jogo</label>
                    <input type="date" id="gameDate" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700">Máximo de Participantes (0-25)</label>
                    <input type="number" id="maxParticipants" min="0" max="25" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700">Máximo de Visitantes (0-10)</label>
                    <input type="number" id="maxGuests" min="0" max="10" class="w-full p-2 border rounded" required>
                </div>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"><i class="fas fa-save"></i> Criar Evento</button>
            </form>
        </div>

        <!-- Seção de Confirmação de Presença -->
        <div id="attendanceSection" class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-bold mb-4"><i class="fas fa-check-circle"></i> Confirmar Presença</h2>
            <form id="attendanceForm">
                <div class="mb-4">
                    <label class="block text-gray-700">Selecionar Integrante</label>
                    <select id="playerSelect" class="w-full p-2 border rounded" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div id="guestSection" class="mb-4" style="display: none;">
                    <label class="block text-gray-700">Adicionar Convidado</label>
                    <input type="text" id="guestName" class="w-full p-2 border rounded mb-2" placeholder="Nome do convidado">
                    <button type="button" id="addGuestBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"><i class="fas fa-user-plus"></i> Adicionar Convidado</button>
                </div>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"><i class="fas fa-check"></i> Confirmar Presença</button>
            </form>
            <div id="message" class="mt-4 text-red-500 hidden"></div>
        </div>

        <!-- Listas de Presença e Espera -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4"><i class="fas fa-list"></i> Lista de Presença</h2>
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="p-2 text-left">Nome</th>
                        <th class="p-2 text-left">Categoria</th>
                        <th class="p-2 text-left">Status</th>
                        <th class="p-2 text-left">Convidado por</th>
                        <th class="p-2 text-left">Taxa (R$)</th>
                    </tr>
                </thead>
                <tbody id="attendanceList"></tbody>
            </table>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md mt-6">
            <h2 class="text-2xl font-bold mb-4"><i class="fas fa-hourglass-half"></i> Lista de Espera</h2>
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="p-2 text-left">Nome</th>
                        <th class="p-2 text-left">Categoria</th>
                        <th class="p-2 text-left">Status</th>
                        <th class="p-2 text-left">Convidado por</th>
                        <th class="p-2 text-left">Taxa (R$)</th>
                    </tr>
                </thead>
                <tbody id="waitingList"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, get, set, push, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWMgLaPMpNOdPW10S-bVVEiQW-r3QCkxg",
            authDomain: "volei-25301.firebaseapp.com",
            databaseURL: "https://volei-25301-default-rtdb.firebaseio.com",
            projectId: "volei-25301",
            storageBucket: "volei-25301.firebasestorage.app",
            messagingSenderId: "1007197261034",
            appId: "1:1007197261034:web:f2c7ab9cb2793a694cdb93",
            measurementId: "G-CYMLX0SJJQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Elementos DOM
        const userEmail = document.getElementById('userEmail');
        const eventCreation = document.getElementById('eventCreation');
        const eventForm = document.getElementById('eventForm');
        const attendanceForm = document.getElementById('attendanceForm');
        const playerSelect = document.getElementById('playerSelect');
        const guestSection = document.getElementById('guestSection');
        const guestName = document.getElementById('guestName');
        const addGuestBtn = document.getElementById('addGuestBtn');
        const attendanceList = document.getElementById('attendanceList');
        const waitingList = document.getElementById('waitingList');
        const message = document.getElementById('message');
        const logoutBtn = document.getElementById('logoutBtn');

        // Emails de exceção
        const exceptionEmails = ['admin1@example.com', 'admin2@example.com', 'admin3@example.com'];

        // Variáveis globais
        let currentUserEmail = '';
        let players = [];
        let eventData = null;
        let guests = [];

        // Verificar autenticação
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                currentUserEmail = user.email;
                userEmail.textContent = `Logado como: ${user.email}`;
                loadPlayers();
                checkEvent();
            }
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Error signing out:', error);
            });
        });

        // Carregar jogadores
        async function loadPlayers() {
            try {
                const playersRef = ref(database, 'players');
                const snapshot = await get(playersRef);
                if (snapshot.exists()) {
                    players = Object.entries(snapshot.val()).map(([id, player]) => ({ id, ...player }));
                    players.sort((a, b) => a.name.localeCompare(b.name));
                    populatePlayerSelect();
                }
            } catch (error) {
                console.error('Error loading players:', error);
                showMessage('Erro ao carregar jogadores', 'error');
            }
        }

        // Preencher select de jogadores
        function populatePlayerSelect() {
            playerSelect.innerHTML = '<option value="">Selecione...</option>';
            players.forEach(player => {
                const option = document.createElement('option');
                option.value = player.id;
                option.textContent = `${player.name} (${player.email})`;
                playerSelect.appendChild(option);
            });
        }

        // Verificar se já existe evento
        async function checkEvent() {
            try {
                const eventsRef = ref(database, 'events');
                onValue(eventsRef, (snapshot) => {
                    if (snapshot.exists()) {
                        eventData = Object.values(snapshot.val())[0]; // Último evento
                        eventCreation.style.display = exceptionEmails.includes(currentUserEmail) ? 'block' : 'none';
                        loadAttendance();
                    } else {
                        eventCreation.style.display = 'block';
                    }
                });
            } catch (error) {
                console.error('Error checking event:', error);
                showMessage('Erro ao verificar evento', 'error');
            }
        }

        // Criar evento
        eventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const gameDate = document.getElementById('gameDate').value;
            const maxParticipants = parseInt(document.getElementById('maxParticipants').value);
            const maxGuests = parseInt(document.getElementById('maxGuests').value);

            try {
                const eventsRef = ref(database, 'events');
                await push(eventsRef, { gameDate, maxParticipants, maxGuests, createdAt: new Date().toISOString() });
                showMessage('Evento criado com sucesso!', 'success');
                eventForm.reset();
            } catch (error) {
                console.error('Error creating event:', error);
                showMessage('Erro ao criar evento', 'error');
            }
        });

        // Confirmar presença
        attendanceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const playerId = playerSelect.value;
            const player = players.find(p => p.id === playerId);

            if (!player) {
                showMessage('Selecione um integrante', 'error');
                return;
            }

            // Verificar se é o mesmo email ou email de exceção
            if (player.email !== currentUserEmail && !exceptionEmails.includes(currentUserEmail)) {
                showMessage('Você não tem permissão para confirmar terceiros', 'error');
                return;
            }

            // Verificar pendências
            const hasPending = await checkPendingStatus(player.id);
            try {
                const attendancesRef = ref(database, `attendances/${eventData.id}`);
                const snapshot = await get(attendancesRef);
                const currentAttendees = snapshot.exists() ? Object.values(snapshot.val()) : [];

                // Verificar limite de participantes
                const confirmedCount = currentAttendees.filter(a => !a.isGuest).length;
                const isWaiting = confirmedCount >= eventData.maxParticipants;

                await push(attendancesRef, {
                    playerId,
                    name: player.name,
                    email: player.email,
                    category: player.category,
                    isGuest: false,
                    isWaiting,
                    pendingStatus: hasPending,
                    timestamp: new Date().toISOString()
                });

                showMessage('Presença confirmada com sucesso!', 'success');
                attendanceForm.reset();
                guestSection.style.display = hasPending ? 'none' : 'block';
            } catch (error) {
                console.error('Error confirming attendance:', error);
                showMessage('Erro ao confirmar presença', 'error');
            }
        });

        // Adicionar convidado
        addGuestBtn.addEventListener('click', async () => {
            const playerId = playerSelect.value;
            const player = players.find(p => p.id === playerId);
            const guestNameValue = guestName.value.trim();

            if (!player || !guestNameValue) {
                showMessage('Selecione um integrante e insira o nome do convidado', 'error');
                return;
            }

            // Verificar limite de convidados
            const attendancesRef = ref(database, `attendances/${eventData.id}`);
            const snapshot = await get(attendancesRef);
            const currentGuests = snapshot.exists() ? Object.values(snapshot.val()).filter(a => a.isGuest) : [];
            if (currentGuests.length >= eventData.maxGuests) {
                showMessage('Limite de convidados atingido', 'error');
                return;
            }

            try {
                await push(attendancesRef, {
                    playerId,
                    name: guestNameValue,
                    email: '',
                    category: 'Convidado',
                    isGuest: true,
                    isWaiting: false,
                    pendingStatus: false,
                    invitedBy: player.name,
                    guestFee: 5.00,
                    timestamp: new Date().toISOString()
                });

                showMessage('Convidado adicionado com sucesso! Taxa de R$5,00 aplicada.', 'success');
                guestName.value = '';
            } catch (error) {
                console.error('Error adding guest:', error);
                showMessage('Erro ao adicionar convidado', 'error');
            }
        });

        // Verificar pendências
        async function checkPendingStatus(playerId) {
            try {
                const paymentsRef = ref(database, 'payments');
                const snapshot = await get(paymentsRef);
                const payments = snapshot.val() || {};
                const playerPayments = Object.values(payments).filter(p => p.playerId === playerId);
                return playerPayments.some(p => p.value === 0 || p.value === '0');
            } catch (error) {
                console.error('Error checking payments:', error);
                return false;
            }
        }

        // Carregar lista de presença e espera
        async function loadAttendance() {
            try {
                const attendancesRef = ref(database, `attendances/${eventData.id}`);
                onValue(attendancesRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const attendances = Object.values(snapshot.val());
                        // Ordenar por categoria: Mensal > Diária > Convidado
                        attendances.sort((a, b) => {
                            const order = { 'Mensal': 1, 'Diária': 2, 'Convidado': 3 };
                            return order[a.category] - order[b.category];
                        });

                        const confirmed = attendances.filter(a => !a.isWaiting);
                        const waiting = attendances.filter(a => a.isWaiting);

                        renderList(confirmed, attendanceList);
                        renderList(waiting, waitingList);
                    } else {
                        attendanceList.innerHTML = '<tr><td colspan="5">Nenhuma presença confirmada</td></tr>';
                        waitingList.innerHTML = '<tr><td colspan="5">Nenhuma espera registrada</td></tr>';
                    }
                });
            } catch (error) {
                console.error('Error loading attendance:', error);
                showMessage('Erro ao carregar listas', 'error');
            }
        }

        // Renderizar listas
        function renderList(list, element) {
            element.innerHTML = '';
            list.forEach(item => {
                const row = document.createElement('tr');
                const statusColor = item.pendingStatus ? 'text-red-500' : 'text-blue-500';
                row.innerHTML = `
                    <td class="p-2">${item.name}</td>
                    <td class="p-2">${item.category}</td>
                    <td class="p-2 ${statusColor}">${item.pendingStatus ? 'Pendente' : 'Em dia'}</td>
                    <td class="p-2">${item.invitedBy || '-'}</td>
                    <td class="p-2">${item.guestFee ? `R$${item.guestFee.toFixed(2)}` : '-'}</td>
                `;
                element.appendChild(row);
            });
        }

        // Exibir mensagem
        function showMessage(text, type) {
            message.textContent = text;
            message.className = `mt-4 ${type === 'error' ? 'text-red-500' : 'text-green-500'}`;
            message.classList.remove('hidden');
            setTimeout(() => message.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>
