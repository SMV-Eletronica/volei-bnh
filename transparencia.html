<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vôlei BNH</title>
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="transpstyles.css?v=1.0">


   
</head>
<body>
    <div class="header">
        <center><h2><i class="fas fa-volleyball-ball" style="color:#3498db;"></i> Vôlei-BNH</h2></center>
        <div class="button-container">
            <button id="loginBtn" class="login-btn" onclick="window.location.href='dashboard.html'"><i class="fas fa-gear"></i></button>
            <button class="enquete-btn" onclick="window.location.href='lista.html'"><i class="fas fa-list"></i> Jogos</button>
            <button class="enquete-btn" onclick="window.location.href='enquete.html'"><i class="fas fa-question-circle"></i> Enquetes</button>
            <button id="logoutBtn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </div>
        <div id="userEmail"></div>
    </div>
    <div class="container">
        <br>
        <div class="tabs">
            <div class="tab active" data-tab="report"><i class="fas fa-file-alt"></i> Caixa</div>
            <div class="tab" data-tab="expenses"><i class="fas fa-receipt"></i> Despesas</div>
            <div class="tab" data-tab="profile"><i class="fas fa-users"></i> Integrantes</div>
        </div>
        <div id="report" class="tab-content active">
            <div class="section">
                <h2 class="section-title"><i class="fas fa-chart-pie"></i> Resumo Financeiro</h2>
                <div class="filter-controls">
                    <div>
                        <label for="yearFilter">Ano:</label>
                        <select id="yearFilter">
                            <option value="all">Todos</option>
                        </select>
                    </div>
                    <div>
                        <label for="monthFilter">Mês:</label>
                        <select id="monthFilter">
                            <option value="all">Todos</option>
                            <option value="01">Janeiro</option>
                            <option value="02">Fevereiro</option>
                            <option value="03">Março</option>
                            <option value="04">Abril</option>
                            <option value="05">Maio</option>
                            <option value="06">Junho</option>
                            <option value="07">Julho</option>
                            <option value="08">Agosto</option>
                            <option value="09">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                    </div>
                </div>
                <div id="cashSummary" class="cash-summary">
                    <h3>Resumo do Caixa</h3>
                    <div class="cash-summary-grid">
                        <div class="cash-summary-item">
                            <div class="cash-summary-title">Total Receita Recebida</div>
                            <div id="totalIncome" class="cash-summary-value">R$ 0,00</div>
                        </div>
                        <div class="cash-summary-item">
                            <div class="cash-summary-title">Total Receitas a Receber</div>
                            <div id="totalReceivables" class="cash-summary-value">R$ 0,00</div>
                        </div>
                        <div class="cash-summary-item">
                            <div class="cash-summary-title">Total Despesas</div>
                            <div id="totalExpenses" class="cash-summary-value">R$ 0,00</div>
                        </div>
                        <div class="cash-summary-item">
                            <div class="cash-summary-title">Saldo Atual</div>
                            <div id="currentBalance" class="cash-summary-value">R$ 0,00</div>
                        </div>
                    </div>
                </div>
                <div id="financialSummary">
                    <table>
                        <thead>
                            <tr>
                                <th>Mês/Ano</th>
                                <th>Receitas Recebidas (R$)</th>
                                <th>Receitas a Receber (R$)</th>
                                <th>Despesas (R$)</th>
                                <th>Saldo (R$)</th>
                            </tr>
                        </thead>
                        <tbody id="financialData">
                        </tbody>
                    </table>
                </div>
                <br>
                <div class="defaulters-section">
                    <h3><i class="fas fa-exclamation-triangle"></i> Integrantes Pendentes</h3>
                    <div id="defaultersList" class="defaulters-list">
                        <div class="no-defaulters">Carregando informações...</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="expenses" class="tab-content">
            <div class="section">
                <h2 class="section-title"><i class="fas fa-history"></i> Controle de Despesas</h2>
                <div id="recentExpenses" class="expenses-list">
                    <div class="expenses-section">
                        <h3 class="section-title"><i class="fas fa-money-bill-wave"></i> Ativas</h3>
                        <div id="activeExpenses" class="expenses-list"></div>
                    </div>
                    <div class="expenses-section">
                        <h3 class="section-title"><i class="fas fa-trash"></i> Canceladas</h3>
                        <div id="deletedExpenses" class="expenses-list"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="profile" class="tab-content">
            <div class="section">
                <br>
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="Pesquisar integrante...">
                </div>
                <div class="profile-container">
                    <div class="profile-header">
                        <button id="prevPlayer" class="nav-arrow" aria-label="Jogador anterior">←</button>
                        <img id="profilePhoto" class="profile-photo" src="" alt="Foto do integrante">
                        <button id="nextPlayer" class="nav-arrow" aria-label="Próximo jogador">→</button>
                    </div>
                    <div class="profile-details">
                        <h2 id="profileName" class="profile-name">Carregando...</h2>
                        <div class="profile-info">
                            <div class="info-item">
                                <div class="info-label">Posição</div>
                                <div id="playerPosition" class="info-value">-</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Categoria</div>
                                <div id="playerCategory" class="info-value">-</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Contato</div>
                                <div id="playerContact" class="info-value">-</div>
                            </div>
                        </div>
                        <div class="payment-status">
                            <h3 class="status-title">Status das Contribuições</h3>
                            <div id="paymentsList"></div>
                        </div>
                        <div id="pendingStatus" class="pending-alert" style="display: none;">
                            Este integrante possui pendências!
                        </div>
                        <div id="noPendingStatus" class="no-pending" style="display: none;">
                            Integrante em dia com as Contribuições!
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="footer">
            © 2025 Marcio Vasques - Todos os direitos reservados<br>
            <div class="footer-links">
                Powered by:
                <a href="https://github.com/seu-usuario" target="_blank" class="github-link">
                    <i class="fab fa-github"></i> GitHub
                </a>
                <a href="https://firebase.google.com/" target="_blank" class="firebase-link">
                    <i class="fas fa-fire"></i> Firebase
                </a>
            </div>
        </footer>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWMgLaPMpNOdPW10S-bVVEiQW-r3QCkxg",
            authDomain: "volei-25301.firebaseapp.com",
            databaseURL: "https://volei-25301-default-rtdb.firebaseio.com",
            projectId: "volei-25301",
            storageBucket: "volei-25301.firebasestorage.app",
            messagingSenderId: "1007197261034",
            appId: "1:1007197261034:web:f2c7ab9cb2793a694cdb93",
            measurementId: "G-CYMLX0SJJQ"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        const yearFilter = document.getElementById('yearFilter');
        const monthFilter = document.getElementById('monthFilter');
        const financialData = document.getElementById('financialData');
        const defaultersList = document.getElementById('defaultersList');
        const activeExpenses = document.getElementById('activeExpenses');
        const deletedExpensesElement = document.getElementById('deletedExpenses');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const totalIncomeElement = document.getElementById('totalIncome');
        const totalReceivablesElement = document.getElementById('totalReceivables');
        const totalExpensesElement = document.getElementById('totalExpenses');
        const currentBalanceElement = document.getElementById('currentBalance');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginBtn = document.getElementById('loginBtn');

        const profilePhoto = document.getElementById('profilePhoto');
        const profileName = document.getElementById('profileName');
        const playerPosition = document.getElementById('playerPosition');
        const playerCategory = document.getElementById('playerCategory');
        const playerContact = document.getElementById('playerContact');
        const paymentsList = document.getElementById('paymentsList');
        const prevPlayerBtn = document.getElementById('prevPlayer');
        const nextPlayerBtn = document.getElementById('nextPlayer');
        const searchInput = document.getElementById('searchInput');
        const pendingStatus = document.getElementById('pendingStatus');
        const noPendingStatus = document.getElementById('noPendingStatus');

        let players = [];
        let currentPlayerIndex = 0;
        let filteredPlayers = [];
        let emailLogado = null;
        let isAdmin = false;
        let currentUserPlayer = null;
        let allPlayers = [];
        const adminEmails = ['mvvasques@msn.com', 'fabioluiztx@outlook.com', 'evandro@msn.com'];

        function updateButtonVisibility(user) {
            if (user) {
                logoutBtn.style.display = 'block';
                loginBtn.style.display = isAdmin ? 'inline-block' : 'none';
            } else {
                logoutBtn.style.display = 'none';
                loginBtn.style.display = 'inline-block';
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                updateButtonVisibility(null);
                await Swal.fire({
                    icon: 'error',
                    title: 'Acesso Negado',
                    text: 'Você precisa estar logado para acessar esta página.',
                });
                window.location.href = 'loginvl.html';
            } else {
                emailLogado = user.email;
                isAdmin = adminEmails.includes(emailLogado);
                const player = await loadCurrentUserPlayer();
                document.getElementById('userEmail').textContent = `Logado como: ${currentUserPlayer?.name || 'Usuário'} (${user.email})`;
                updateButtonVisibility(user);
                await loadCurrentUserPlayer();
                loadFinancialData();
                loadDefaulters();
                loadRecentExpenses();
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                await Swal.fire({
                    icon: 'success',
                    title: 'Logout',
                    text: 'Você saiu com sucesso.',
                    timer: 500,
                    showConfirmButton: false,
                });
                window.location.href = 'loginvl.html';
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
                await Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Não foi possível fazer logout. Tente novamente.',
                });
            }
        });

        loginBtn.addEventListener('click', () => {
            window.location.href = 'dashboard.html';
        });

        async function loadCurrentUserPlayer() {
            try {
                const playersRef = ref(database, 'players');
                const snapshot = await get(playersRef);
                if (snapshot.exists()) {
                    allPlayers = Object.entries(snapshot.val()).map(([id, player]) => ({
                        id,
                        ...player
                    }));
                    currentUserPlayer = allPlayers.find(player => player.email === emailLogado);
                    if (!currentUserPlayer) {
                        await Swal.fire({
                            icon: 'error',
                            title: 'Erro',
                            text: 'Nenhum jogador associado a este email. Contate o administrador.',
                        });
                    }
                    return currentUserPlayer;
                } else {
                    await Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: 'Nenhum jogador encontrado no sistema.',
                    });
                    return null;
                }
            } catch (error) {
                console.error('Erro ao carregar dados do jogador:', error);
                await Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao carregar seus dados.',
                });
            }
        }

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
                if (tab.dataset.tab === 'profile') {
                    loadPlayers();
                }
            });
        });

        async function loadFinancialData() {
            const currentSelectedYear = yearFilter.value;
            const currentSelectedMonth = monthFilter.value;
            yearFilter.disabled = true;
            const paymentsRef = ref(database, 'payments');
            const expensesRef = ref(database, 'expenses');
            try {
                const [paymentsSnapshot, expensesSnapshot] = await Promise.all([
                    get(paymentsRef),
                    get(expensesRef)
                ]);
                const paymentsData = paymentsSnapshot.val() || {};
                const expenses = expensesSnapshot.val() || {};
                const monthlyData = {};
                const years = new Set();
                let filteredIncome = 0;
                let filteredReceivables = 0;
                let filteredExpenses = 0;
                console.log('Processing payments data:', paymentsData);
                for (const year in paymentsData) {
                    for (const month in paymentsData[year]) {
                        const payments = paymentsData[year][month];
                        const normalizedMonth = month.padStart(2, '0');
                        years.add(year);
                        const matchesYear = currentSelectedYear === 'all' || year === currentSelectedYear;
                        const matchesMonth = currentSelectedMonth === 'all' || normalizedMonth === currentSelectedMonth;
                        if (!matchesYear || !matchesMonth) continue;
                        for (const paymentId in payments) {
                            const payment = payments[paymentId];
                            if (!payment.month || payment.value === undefined) continue;
                            const [paymentYear, paymentMonth] = payment.month.split('-');
                            const monthKey = `${paymentYear}-${paymentMonth}`;
                            const monthName = getMonthName(paymentMonth);
                            if (!monthlyData[monthKey]) {
                                monthlyData[monthKey] = {
                                    monthName,
                                    year: paymentYear,
                                    month: paymentMonth,
                                    income: 0,
                                    receivables: 0,
                                    expenses: 0,
                                    paymentsCount: 0,
                                    lateCount: 0
                                };
                            }
                            const paymentValue = parseFloat(payment.value) || 0;
                            if (payment.date) {
                                monthlyData[monthKey].income += paymentValue;
                                filteredIncome += paymentValue;
                            } else {
                                monthlyData[monthKey].receivables += paymentValue;
                                monthlyData[monthKey].lateCount++;
                                filteredReceivables += paymentValue;
                            }
                            monthlyData[monthKey].paymentsCount++;
                        }
                    }
                }
                console.log('Processing expenses data:', expenses);
                for (const expenseId in expenses) {
                    const expense = expenses[expenseId];
                    if (!expense.month || expense.value === undefined) continue;
                    const [year, month] = expense.month.split('-');
                    years.add(year);
                    const matchesYear = currentSelectedYear === 'all' || year === currentSelectedYear;
                    const matchesMonth = currentSelectedMonth === 'all' || month === currentSelectedMonth;
                    if (!matchesYear || !matchesMonth) continue;
                    const monthKey = `${year}-${month}`;
                    if (!monthlyData[monthKey]) {
                        const monthName = getMonthName(month);
                        monthlyData[monthKey] = {
                            monthName,
                            year,
                            month,
                            income: 0,
                            receivables: 0,
                            expenses: 0,
                            paymentsCount: 0,
                            lateCount: 0
                        };
                    }
                    const expenseValue = parseFloat(expense.value) || 0;
                    monthlyData[monthKey].expenses += expenseValue;
                    filteredExpenses += expenseValue;
                }
                updateYearFilterOptions(Array.from(years).sort().reverse());
                updateCashSummary(filteredIncome, filteredReceivables, filteredExpenses);
                renderFinancialData(monthlyData);
            } catch (error) {
                console.error("Error loading financial data:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao carregar dados financeiros.',
                });
            } finally {
                yearFilter.disabled = false;
            }
        }

        function updateYearFilterOptions(years) {
            const currentSelectedYear = yearFilter.value;
            yearFilter.innerHTML = '<option value="all">Todos</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
            if (currentSelectedYear !== 'all' && years.includes(currentSelectedYear)) {
                yearFilter.value = currentSelectedYear;
            } else {
                yearFilter.value = 'all';
            }
        }

        function updateCashSummary(income, receivables, expenses) {
            const balance = income - expenses;
            totalIncomeElement.textContent = `R$ ${income.toFixed(2)}`;
            totalReceivablesElement.textContent = `R$ ${receivables.toFixed(2)}`;
            totalExpensesElement.textContent = `R$ ${expenses.toFixed(2)}`;
            currentBalanceElement.textContent = `R$ ${Math.abs(balance).toFixed(2)}`;
            currentBalanceElement.className = `cash-summary-value ${balance >= 0 ? 'positive' : 'negative'}`;
            if (balance < 0) {
                currentBalanceElement.textContent = `-R$ ${Math.abs(balance).toFixed(2)}`;
            }
        }

        async function loadDefaulters() {
            const paymentsRef = ref(database, 'payments');
            const playersRef = ref(database, 'players');
            try {
                const [paymentsSnapshot, playersSnapshot] = await Promise.all([
                    get(paymentsRef),
                    get(playersRef)
                ]);
                const paymentsData = paymentsSnapshot.val() || {};
                const players = playersSnapshot.val() || {};
                const defaulters = {};
                const selectedYear = yearFilter.value;
                const selectedMonth = monthFilter.value;
                console.log('Processing defaulters from payments:', paymentsData);
                for (const year in paymentsData) {
                    for (const month in paymentsData[year]) {
                        const payments = paymentsData[year][month];
                        const normalizedMonth = month.padStart(2, '0');
                        if (selectedYear !== 'all' && year !== selectedYear) continue;
                        if (selectedMonth !== 'all' && normalizedMonth !== selectedMonth) continue;
                        for (const paymentId in payments) {
                            const payment = payments[paymentId];
                            if (!payment.date && payment.value > 0) {
                                if (!defaulters[payment.playerId]) {
                                    defaulters[payment.playerId] = {
                                        name: payment.playerName,
                                        months: [],
                                        photo: players[payment.playerId]?.imageUrl || null
                                    };
                                }
                                defaulters[payment.playerId].months.push(payment.month);
                            }
                        }
                    }
                }
                renderDefaultersList(defaulters);
            } catch (error) {
                console.error("Error loading defaulters:", error);
                defaultersList.innerHTML = '<div class="no-defaulters">Erro ao carregar inadimplentes</div>';
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao carregar inadimplentes.',
                });
            }
        }

        function renderDefaultersList(defaulters) {
            defaultersList.innerHTML = '';
            if (Object.keys(defaulters).length === 0) {
                defaultersList.innerHTML = '<div class="no-defaulters">Nenhum integrante inadimplente no período selecionado</div>';
                return;
            }
            Object.entries(defaulters).forEach(([playerId, defaulter]) => {
                const defaulterEl = document.createElement('div');
                defaulterEl.className = 'defaulter-item';
                defaulterEl.style.cursor = 'pointer';
                const formattedMonths = defaulter.months.map(month => {
                    const [year, monthNum] = month.split('-');
                    return `${getMonthName(monthNum)}/${year}`;
                }).join(', ');
                defaulterEl.innerHTML = `
                    ${defaulter.photo ? 
                        `<img src="${defaulter.photo}" class="defaulter-photo" alt="${defaulter.name}">` : 
                        '<div class="defaulter-photo" style="background:#eee;"></div>'}
                    <div class="defaulter-info">
                        <div class="defaulter-name">${defaulter.name}</div>
                        <div class="defaulter-months">${formattedMonths}</div>
                    </div>
                `;
                defaulterEl.addEventListener('click', () => {
                    showDefaulterDetails(playerId, defaulter.name);
                });
                defaultersList.appendChild(defaulterEl);
            });
        }

        async function showDefaulterDetails(playerId, playerName) {
            const paymentsRef = ref(database, 'payments');
            try {
                const snapshot = await get(paymentsRef);
                const paymentsData = snapshot.val() || {};
                console.log('Processing defaulter details for player:', playerId, paymentsData);
                const defaulterPayments = [];
                for (const year in paymentsData) {
                    for (const month in paymentsData[year]) {
                        const payments = paymentsData[year][month];
                        for (const paymentId in payments) {
                            const payment = payments[paymentId];
                            if (payment.playerId === playerId && !payment.date && payment.value > 0) {
                                defaulterPayments.push(payment);
                            }
                        }
                    }
                }
                let detailsHtml = `<h3 style="margin-top: 0;">Pendências - ${playerName}</h3>`;
                if (defaulterPayments.length === 0) {
                    detailsHtml += '<p>Nenhuma mensalidade inadimplente encontrada.</p>';
                } else {
                    detailsHtml += '<table style="width: 100%; border-collapse: collapse; font-size: 14px;"><thead><tr style="background-color: #f2f2f2;"><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Mês/Ano</th><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Valor (R$)</th><th style="border: 1px solid #ddd; padding: 8px; text-align: left;"> Tipo / Descrição</th></tr></thead><tbody>';
                    defaulterPayments.forEach(payment => {
                        const [year, month] = payment.month.split('-');
                        const formattedMonth = `${getMonthName(month)}/${year}`;
                        const paymentType = payment.paymentType || 'Não informado';
                        const guestName = payment.guestName || '-';
                        detailsHtml += `<tr><td style="border: 1px solid #ddd; padding: 8px;">${formattedMonth}</td><td style="border: 1px solid #ddd; padding: 8px;">R$ ${parseFloat(payment.value).toFixed(2)}</td><td style="border: 1px solid #ddd; padding: 8px;">${paymentType} / ${guestName}</td></tr>`;
                    });
                    detailsHtml += '</tbody></table>';
                }
                Swal.fire({
                    title: '',
                    html: detailsHtml,
                    icon: defaulterPayments.length > 0 ? 'warning' : 'info',
                    confirmButtonText: 'Fechar',
                    customClass: {
                        popup: 'swal-wide',
                        htmlContainer: 'swal-content'
                    },
                    width: '90%',
                    showCloseButton: true,
                    allowOutsideClick: true,
                    allowEscapeKey: true
                });
            } catch (error) {
                console.error("Error loading defaulter details:", error);
                Swal.fire({
                    title: 'Erro',
                    html: `<p>Não foi possível carregar os detalhes: ${error.message}</p>`,
                    icon: 'error',
                    confirmButtonText: 'Fechar',
                    customClass: {
                        popup: 'swal-wide',
                        htmlContainer: 'swal-content'
                    },
                    width: '90%',
                    showCloseButton: true,
                    allowOutsideClick: true,
                    allowEscapeKey: true
                });
            }
        }

        async function loadRecentExpenses() {
            const expensesRef = ref(database, 'expenses');
            const deletedExpensesRef = ref(database, 'deletedExpenses');
            try {
                const [expensesSnapshot, deletedExpensesSnapshot] = await Promise.all([
                    get(expensesRef),
                    get(deletedExpensesRef)
                ]);
                const activeExpensesData = [];
                const deletedExpensesArray = [];
                const expensesData = expensesSnapshot.val() || {};
                const deletedExpensesData = deletedExpensesSnapshot.val() || {};
                Object.entries(expensesData).forEach(([key, expense]) => {
                    activeExpensesData.push({
                        id: key,
                        ...expense,
                        isDeleted: false
                    });
                });
                Object.entries(deletedExpensesData).forEach(([key, expense]) => {
                    deletedExpensesArray.push({
                        id: key,
                        ...expense,
                        isDeleted: true
                    });
                });
                activeExpensesData.sort((a, b) => new Date(b.date || b.createdAt) - new Date(a.date || a.createdAt));
                deletedExpensesArray.sort((a, b) => new Date(b.date || b.createdAt) - new Date(a.date || a.createdAt));
                renderRecentExpenses(activeExpensesData.slice(0, 10), deletedExpensesArray.slice(0, 10));
            } catch (error) {
                console.error("Error loading recent expenses:", error);
                if (activeExpenses && activeExpenses instanceof HTMLElement) {
                    activeExpenses.innerHTML = '<div class="no-defaulters">Erro ao carregar despesas</div>';
                }
                if (deletedExpensesElement && deletedExpensesElement instanceof HTMLElement) {
                    deletedExpensesElement.innerHTML = '<div class="no-defaulters">Erro ao carregar despesas excluídas</div>';
                }
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao carregar despesas.',
                });
            }
        }

        function renderRecentExpenses(activeExpensesData, deletedExpensesArray) {
            if (!activeExpenses || !(activeExpenses instanceof HTMLElement)) {
                console.error("Elemento 'activeExpenses' não encontrado ou não é um elemento DOM válido.");
                return;
            }
            if (!deletedExpensesElement || !(deletedExpensesElement instanceof HTMLElement)) {
                console.error("Elemento 'deletedExpenses' não encontrado ou não é um elemento DOM válido.");
                return;
            }

            activeExpenses.innerHTML = '';
            deletedExpensesElement.innerHTML = '';

            if (activeExpensesData.length === 0) {
                activeExpenses.innerHTML = '<div class="no-defaulters">Nenhuma despesa registrada</div>';
            } else {
                for (const expense of activeExpensesData) {
                    const [year, month] = expense.month.split('-');
                    const expenseDate = expense.date ? formatDate(expense.date) : formatDate(expense.createdAt);
                    const createdBy = expense.createdByName || 'Não informado';
                    const expenseEl = document.createElement('div');
                    expenseEl.className = 'expense-item';
                    expenseEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <strong>${expenseDate} - ${expenseCategoryName(expense.category)}</strong>
                            <span class="expense-value">R$ ${parseFloat(expense.value).toFixed(2)}</span>
                        </div>
                        <div style="color: #666; margin-bottom: 5px;">
                            ${expense.month ? `${getMonthName(month)}/${year}` : 'Sem mês de referência'}
                        </div>
                        <div style="margin-bottom: 5px;">Descrição: ${expense.description || 'Sem descrição'}</div>
                        <div style="margin-bottom: 5px;">Registrado por: ${createdBy}</div>
                    `;
                    activeExpenses.appendChild(expenseEl);
                }
            }

            if (deletedExpensesArray.length === 0) {
                deletedExpensesElement.innerHTML = '<div class="no-defaulters">Nenhuma despesa excluída</div>';
            } else {
                for (const expense of deletedExpensesArray) {
                    const [year, month] = expense.month.split('-');
                    const expenseDate = expense.date ? formatDate(expense.date) : formatDate(expense.createdAt);
                    const createdBy = expense.createdByName || 'Não informado';
                    const deletedBy = expense.deletedByName || 'Não informado';
                    const deletedAt = expense.deletedAt ? formatDate(expense.deletedAt) : 'Não informado';
                    const deletionReason = expense.deletionReason || 'Não informado';
                    const expenseEl = document.createElement('div');
                    expenseEl.className = 'expenseDel-item';
                    expenseEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <strong>${expenseDate} - ${expenseCategoryName(expense.category)}</strong>
                            <span class="expenseDel-value">R$ ${parseFloat(expense.value).toFixed(2)}</span>
                        </div>
                        <div style="color: #666; margin-bottom: 5px;">
                            ${expense.month ? `${getMonthName(month)}/${year}` : 'Sem mês de referência'}
                        </div>
                        <div style="margin-bottom: 5px;">Descrição: ${expense.description || 'Sem descrição'}</div>
                        <div style="margin-bottom: 5px;">Registrado por: ${createdBy}</div>
                        <div style="margin-bottom: 5px; color: #e74c3c;">
                            Cancelada por: ${deletedBy} em ${deletedAt}<br>
                            Justificativa: ${deletionReason}
                        </div>
                    `;
                    deletedExpensesElement.appendChild(expenseEl);
                }
            }
        }

        function renderFinancialData(monthlyData) {
            const selectedYear = yearFilter.value;
            const selectedMonth = monthFilter.value;
            const sortedMonths = Object.keys(monthlyData).sort().reverse();
            financialData.innerHTML = '';
            for (const monthKey of sortedMonths) {
                const data = monthlyData[monthKey];
                if (selectedYear !== 'all' && data.year !== selectedYear) continue;
                if (selectedMonth !== 'all' && data.month !== selectedMonth) continue;
                const balance = data.income - data.expenses;
                const balanceClass = balance >= 0 ? 'status-pago' : 'status-inadimplente';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.monthName} ${data.year}</td>
                    <td>R$ ${data.income.toFixed(2)}</td>
                    <td>R$ ${data.receivables.toFixed(2)}</td>
                    <td>R$ ${data.expenses.toFixed(2)}</td>
                    <td class="${balanceClass}">R$ ${balance.toFixed(2)}</td>
                `;
                financialData.appendChild(row);
            }
        }

        async function loadPlayers() {
            try {
                const playersRef = ref(database, 'players');
                const snapshot = await get(playersRef);
                if (snapshot.exists()) {
                    players = Object.entries(snapshot.val()).map(([id, player]) => ({ id, ...player }));
                    players.sort((a, b) => a.name.localeCompare(b.name));
                    filteredPlayers = [...players];
                    if (filteredPlayers.length > 0) {
                        currentPlayerIndex = 0;
                        showPlayer(currentPlayerIndex);
                    } else {
                        profileName.textContent = "Nenhum integrante cadastrado";
                    }
                } else {
                    profileName.textContent = "Nenhum integrante cadastrado";
                }
            } catch (error) {
                console.error("Error loading players:", error);
                profileName.textContent = "Erro ao carregar dados";
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao carregar jogadores.',
                });
            }
        }

        function showPlayer(index) {
            if (filteredPlayers.length === 0) return;
            if (index < 0) index = filteredPlayers.length - 1;
            if (index >= filteredPlayers.length) index = 0;
            currentPlayerIndex = index;
            const player = filteredPlayers[index];
            profileName.textContent = player.name || "-";
            playerPosition.textContent = player.position || "-";
            playerCategory.textContent = player.category || "-";
            playerContact.textContent = player.contact || "-";
            if (player.imageUrl) {
                profilePhoto.src = player.imageUrl;
                profilePhoto.style.display = "block";
            } else {
                profilePhoto.style.display = "none";
            }
            loadPlayerPayments(player.id);
            prevPlayerBtn.disabled = filteredPlayers.length <= 1;
            nextPlayerBtn.disabled = filteredPlayers.length <= 1;
        }

        async function loadPlayerPayments(playerId) {
            try {
                const paymentsRef = ref(database, 'payments');
                const deletedPaymentsRef = ref(database, 'deletedPayments');
                const [paymentsSnapshot, deletedPaymentsSnapshot] = await Promise.all([
                    get(paymentsRef),
                    get(deletedPaymentsRef)
                ]);
                let playerPayments = [];
                const paymentsData = paymentsSnapshot.val() || {};
                console.log('Processing payments for player:', playerId, paymentsData);
                for (const year in paymentsData) {
                    for (const month in paymentsData[year]) {
                        const payments = paymentsData[year][month];
                        for (const paymentId in payments) {
                            const payment = payments[paymentId];
                            if (payment.playerId === playerId) {
                                playerPayments.push({ id: paymentId, ...payment, isDeleted: false });
                            }
                        }
                    }
                }
                const deletedPayments = deletedPaymentsSnapshot.val() || {};
                for (const deletedPaymentId in deletedPayments) {
                    const payment = deletedPayments[deletedPaymentId];
                    if (payment.playerId === playerId) {
                        playerPayments.push({ id: deletedPaymentId, ...payment, isDeleted: true });
                    }
                }
                playerPayments.sort((a, b) => b.month.localeCompare(a.month));
                renderPayments(playerPayments);
                const hasPending = playerPayments.some(p => !p.isDeleted && !p.date && p.value > 0);
                if (hasPending) {
                    pendingStatus.style.display = "block";
                    noPendingStatus.style.display = "none";
                } else {
                    pendingStatus.style.display = "none";
                    noPendingStatus.style.display = "block";
                }
            } catch (error) {
                console.error("Error loading payments:", error);
                paymentsList.innerHTML = "<div>Erro ao carregar pagamentos</div>";
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao carregar pagamentos do jogador.',
                });
            }
        }

        function renderPayments(payments) {
            paymentsList.innerHTML = '';
            if (payments.length === 0) {
                paymentsList.innerHTML = "<div>Nenhum pagamento registrado</div>";
                return;
            }
            for (const payment of payments) {
                const isPaid = payment.date && payment.value > 0 && !payment.isDeleted;
                const isExcluded = payment.isDeleted;
                const [year, month] = payment.month.split('-');
                const monthName = getMonthName(month);
                const paymentEl = document.createElement('div');
                paymentEl.className = `status-item ${isExcluded ? 'excluded' : 'active'}`;
                paymentEl.innerHTML = `
                    <div>
                        <span class="status-label">Referente ao Caixa:</span>
                        <span class="status-value">${monthName}/${year}</span>
                    </div>
                    <div>
                        <span class="status-label">Tipo de Pagamento:</span>
                        <span class="status-value">${payment.paymentType || '-'}</span>
                    </div>
                    <div>
                        <span class="status-label">Descrição:</span>
                        <span class="status-value">${payment.additionalInfo || '-'}</span>
                    </div>
                    <div>
                        <span class="status-label">Data do Pagamento:</span>
                        <span class="status-value">${payment.date ? formatDate(payment.date) : '-'}</span>
                    </div>
                    <div>
                        <span class="status-label">Valor:</span>
                        <span class="status-value ${isPaid ? 'paid' : isExcluded ? 'unpaid' : 'unpaid'}">
                            ${isExcluded ? `R$ ${parseFloat(payment.value).toFixed(2)} (Excluído)` : 
                            isPaid ? `R$ ${parseFloat(payment.value).toFixed(2)}` : 
                            `R$ ${parseFloat(payment.value).toFixed(2)} (Pendente)`}
                        </span>
                    </div>
                    ${isExcluded ? `
                    <div>
                        <span class="status-label">Motivo da Exclusão:</span>
                        <span class="status-value">${payment.deleteReason || '-'}</span>
                    </div>
                    <div>
                        <span class="status-label">Data da Exclusão:</span>
                        <span class="status-value">${payment.deletedAt ? formatDate(payment.deletedAt) : '-'}</span>
                    </div>
                    <div>
                        <span class="status-label">Cancelada por:</span>
                        <span class="status-value">${payment.deletedBy || '-'}</span>
                    </div>` : ''}
                `;
                paymentsList.appendChild(paymentEl);
            }
        }

        prevPlayerBtn.addEventListener('click', () => {
            showPlayer(currentPlayerIndex - 1);
        });

        nextPlayerBtn.addEventListener('click', () => {
            showPlayer(currentPlayerIndex + 1);
        });

        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.trim().toLowerCase();
            if (searchTerm === '') {
                filteredPlayers = [...players];
            } else {
                filteredPlayers = players.filter(player => 
                    player.name.toLowerCase().includes(searchTerm)
                );
            }
            if (filteredPlayers.length > 0) {
                currentPlayerIndex = 0;
                showPlayer(currentPlayerIndex);
            } else {
                profileName.textContent = "Nenhum integrante encontrado";
                paymentsList.innerHTML = "";
                pendingStatus.style.display = "none";
                noPendingStatus.style.display = "none";
            }
        });

        function getMonthName(monthNumber) {
            const months = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            return months[parseInt(monthNumber) - 1];
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const offset = date.getTimezoneOffset() * 60000;
            const adjustedDate = new Date(date.getTime() + offset);
            return adjustedDate.toLocaleDateString('pt-BR');
        }

        function expenseCategoryName(category) {
            return category || 'Sem categoria';
        }

        yearFilter.addEventListener('change', () => {
            loadFinancialData();
            loadDefaulters();
        });

        monthFilter.addEventListener('change', () => {
            loadFinancialData();
            loadDefaulters();
        });
    </script>
</body>
</html>
